'use strict';

exports.__esModule = true;

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _entries = require('babel-runtime/core-js/object/entries');

var _entries2 = _interopRequireDefault(_entries);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _path = require('path');

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _child_process = require('child_process');

var _makeDir = require('make-dir');

var _makeDir2 = _interopRequireDefault(_makeDir);

var _process = require('./process');

var _process2 = _interopRequireDefault(_process);

var _tempDirectory = require('../utils/temp-directory');

var _tempDirectory2 = _interopRequireDefault(_tempDirectory);

var _pathPattern = require('../utils/path-pattern');

var _pathPattern2 = _interopRequireDefault(_pathPattern);

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

var _string = require('../utils/string');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:video-recorder');

const VIDEO_EXTENSION = 'mp4';

const TEMP_DIR_PREFIX = 'video';
const TEMP_VIDEO_FILE_PREFIX = 'tmp-video';
const TEMP_MERGE_FILE_PREFIX = TEMP_VIDEO_FILE_PREFIX + '-merge';

const TEMP_MERGE_CONFIG_FILE_PREFIX = 'config';
const TEMP_MERGE_CONFIG_FILE_EXTENSION = 'txt';

class VideoRecorder {
    constructor(browserJob, basePath, opts, encodingOpts, warningLog) {
        this.browserJob = browserJob;
        this.basePath = basePath;
        this.failedOnly = opts.failedOnly;
        this.singleFile = opts.singleFile;
        this.ffmpegPath = opts.ffmpegPath;
        this.customPathPattern = opts.pathPattern;
        this.timeStamp = opts.timeStamp;
        this.encodingOptions = encodingOpts;

        this.warningLog = warningLog;

        this.tempDirectory = new _tempDirectory2.default(TEMP_DIR_PREFIX);
        this.tempVideoPath = '';
        this.tempMergeConfigPath = '';

        this.firstFile = true;

        this.testRunInfo = {};

        this._assignEventHandlers(browserJob);
    }

    _createSafeListener(listener) {
        var _this = this;

        return (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* (...args) {
                try {
                    return yield listener.apply(_this, args);
                } catch (error) {
                    DEBUG_LOGGER(listener && listener.name, error);

                    return void 0;
                }
            });

            return function () {
                return _ref.apply(this, arguments);
            };
        })();
    }

    _assignEventHandlers(browserJob) {
        browserJob.once('start', this._createSafeListener(this._onBrowserJobStart));
        browserJob.once('done', this._createSafeListener(this._onBrowserJobDone));
        browserJob.on('test-run-create', this._createSafeListener(this._onTestRunCreate));
        browserJob.on('test-run-ready', this._createSafeListener(this._onTestRunReady));
        browserJob.on('test-run-before-done', this._createSafeListener(this._onTestRunBeforeDone));
    }

    _addProblematicPlaceholdersWarning(placeholders) {
        const problematicPlaceholderListStr = (0, _string.getConcatenatedValuesString)(placeholders);
        const suffix = (0, _string.getPluralSuffix)(placeholders);
        const verb = (0, _string.getToBeInPastTense)(placeholders);

        this.warningLog.addWarning(_warningMessage2.default.problematicPathPatternPlaceholderForVideoRecording, problematicPlaceholderListStr, suffix, suffix, verb);
    }

    _getTargetVideoPath(testRunInfo) {
        const test = testRunInfo.test,
              index = testRunInfo.index,
              testRun = testRunInfo.testRun;


        const connection = testRun.browserConnection;

        const pathPattern = new _pathPattern2.default(this.customPathPattern, VIDEO_EXTENSION, {
            testIndex: this.singleFile ? null : index,
            quarantineAttempt: null,
            now: this.timeStamp,
            fixture: this.singleFile ? null : test.fixture.name,
            test: this.singleFile ? null : test.name,
            parsedUserAgent: connection.browserInfo.parsedUserAgent
        });

        pathPattern.on('problematic-placeholders-found', ({ placeholders }) => this._addProblematicPlaceholdersWarning(placeholders));

        return (0, _path.join)(this.basePath, pathPattern.getPath());
    }

    _generateTempNames(id) {
        const tempFileNames = {
            tempVideoPath: `${TEMP_VIDEO_FILE_PREFIX}-${id}.${VIDEO_EXTENSION}`,
            tempMergeConfigPath: `${TEMP_MERGE_CONFIG_FILE_PREFIX}-${id}.${TEMP_MERGE_CONFIG_FILE_EXTENSION}`,
            tmpMergeName: `${TEMP_MERGE_FILE_PREFIX}-${id}.${VIDEO_EXTENSION}`
        };

        for (var _iterator = (0, _entries2.default)(tempFileNames), _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : (0, _getIterator3.default)(_iterator);;) {
            var _ref3;

            if (_isArray) {
                if (_i >= _iterator.length) break;
                _ref3 = _iterator[_i++];
            } else {
                _i = _iterator.next();
                if (_i.done) break;
                _ref3 = _i.value;
            }

            const _ref2 = _ref3;
            const tempFile = _ref2[0];
            const tempName = _ref2[1];

            tempFileNames[tempFile] = (0, _path.join)(this.tempDirectory.path, tempName);
        }return tempFileNames;
    }

    _concatVideo(targetVideoPath, { tempVideoPath, tempMergeConfigPath, tmpMergeName }) {
        if (this.firstFile) {
            this.firstFile = false;
            return;
        }

        _fs2.default.writeFileSync(tempMergeConfigPath, `
            file '${targetVideoPath}'
            file '${tempVideoPath}'
        `);

        (0, _child_process.spawnSync)(this.ffmpegPath, ['-y', '-f', 'concat', '-safe', '0', '-i', tempMergeConfigPath, '-c', 'copy', tmpMergeName], { stdio: 'ignore' });
        _fs2.default.copyFileSync(tmpMergeName, tempVideoPath);
    }

    _onBrowserJobStart() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this2.tempDirectory.init();
        })();
    }

    _onBrowserJobDone() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this3.tempDirectory.dispose();
        })();
    }

    _onTestRunCreate({ testRun, legacy, quarantine, test, index }) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (legacy) return;

            const testRunInfo = { testRun, quarantine, test, index };

            const connection = testRun.browserConnection;

            const connectionCapabilities = yield testRun.browserConnection.provider.hasCustomActionForBrowser(connection.id);

            if (!connectionCapabilities || !connectionCapabilities.hasGetVideoFrameData) {
                _this4.browserJob.warningLog.addWarning(_warningMessage2.default.videoNotSupportedByBrowser, connection.browserInfo.alias);

                return;
            }

            _this4.testRunInfo[index] = testRunInfo;

            testRunInfo.tempFiles = _this4._generateTempNames(connection.id);

            testRunInfo.videoRecorder = new _process2.default(testRunInfo.tempFiles.tempVideoPath, _this4.ffmpegPath, connection, _this4.encodingOptions);

            yield testRunInfo.videoRecorder.init();
        })();
    }

    _onTestRunReady(testRunController) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const testRunInfo = _this5.testRunInfo[testRunController.index];

            if (!testRunInfo) return;

            yield testRunInfo.videoRecorder.startCapturing();
        })();
    }

    _onTestRunBeforeDone(testRunController) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const testRunInfo = _this6.testRunInfo[testRunController.index];

            if (!testRunInfo) return;

            delete _this6.testRunInfo[testRunController.index];

            yield testRunInfo.videoRecorder.finishCapturing();

            const videoPath = _this6._getTargetVideoPath(testRunInfo);

            if (_this6.failedOnly && !testRunController.testRun.errs.length) return;

            yield (0, _makeDir2.default)((0, _path.dirname)(videoPath));

            if (_this6.singleFile) _this6._concatVideo(videoPath, testRunInfo.tempFiles);

            _fs2.default.copyFileSync(testRunInfo.tempFiles.tempVideoPath, videoPath);
        })();
    }
}
exports.default = VideoRecorder;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92aWRlby1yZWNvcmRlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJERUJVR19MT0dHRVIiLCJWSURFT19FWFRFTlNJT04iLCJURU1QX0RJUl9QUkVGSVgiLCJURU1QX1ZJREVPX0ZJTEVfUFJFRklYIiwiVEVNUF9NRVJHRV9GSUxFX1BSRUZJWCIsIlRFTVBfTUVSR0VfQ09ORklHX0ZJTEVfUFJFRklYIiwiVEVNUF9NRVJHRV9DT05GSUdfRklMRV9FWFRFTlNJT04iLCJWaWRlb1JlY29yZGVyIiwiY29uc3RydWN0b3IiLCJicm93c2VySm9iIiwiYmFzZVBhdGgiLCJvcHRzIiwiZW5jb2RpbmdPcHRzIiwid2FybmluZ0xvZyIsImZhaWxlZE9ubHkiLCJzaW5nbGVGaWxlIiwiZmZtcGVnUGF0aCIsImN1c3RvbVBhdGhQYXR0ZXJuIiwicGF0aFBhdHRlcm4iLCJ0aW1lU3RhbXAiLCJlbmNvZGluZ09wdGlvbnMiLCJ0ZW1wRGlyZWN0b3J5IiwiVGVtcERpcmVjdG9yeSIsInRlbXBWaWRlb1BhdGgiLCJ0ZW1wTWVyZ2VDb25maWdQYXRoIiwiZmlyc3RGaWxlIiwidGVzdFJ1bkluZm8iLCJfYXNzaWduRXZlbnRIYW5kbGVycyIsIl9jcmVhdGVTYWZlTGlzdGVuZXIiLCJsaXN0ZW5lciIsImFyZ3MiLCJhcHBseSIsImVycm9yIiwibmFtZSIsIm9uY2UiLCJfb25Ccm93c2VySm9iU3RhcnQiLCJfb25Ccm93c2VySm9iRG9uZSIsIm9uIiwiX29uVGVzdFJ1bkNyZWF0ZSIsIl9vblRlc3RSdW5SZWFkeSIsIl9vblRlc3RSdW5CZWZvcmVEb25lIiwiX2FkZFByb2JsZW1hdGljUGxhY2Vob2xkZXJzV2FybmluZyIsInBsYWNlaG9sZGVycyIsInByb2JsZW1hdGljUGxhY2Vob2xkZXJMaXN0U3RyIiwic3VmZml4IiwidmVyYiIsImFkZFdhcm5pbmciLCJXQVJOSU5HX01FU1NBR0VTIiwicHJvYmxlbWF0aWNQYXRoUGF0dGVyblBsYWNlaG9sZGVyRm9yVmlkZW9SZWNvcmRpbmciLCJfZ2V0VGFyZ2V0VmlkZW9QYXRoIiwidGVzdCIsImluZGV4IiwidGVzdFJ1biIsImNvbm5lY3Rpb24iLCJicm93c2VyQ29ubmVjdGlvbiIsIlBhdGhQYXR0ZXJuIiwidGVzdEluZGV4IiwicXVhcmFudGluZUF0dGVtcHQiLCJub3ciLCJmaXh0dXJlIiwicGFyc2VkVXNlckFnZW50IiwiYnJvd3NlckluZm8iLCJnZXRQYXRoIiwiX2dlbmVyYXRlVGVtcE5hbWVzIiwiaWQiLCJ0ZW1wRmlsZU5hbWVzIiwidG1wTWVyZ2VOYW1lIiwidGVtcEZpbGUiLCJ0ZW1wTmFtZSIsInBhdGgiLCJfY29uY2F0VmlkZW8iLCJ0YXJnZXRWaWRlb1BhdGgiLCJmcyIsIndyaXRlRmlsZVN5bmMiLCJzdGRpbyIsImNvcHlGaWxlU3luYyIsImluaXQiLCJkaXNwb3NlIiwibGVnYWN5IiwicXVhcmFudGluZSIsImNvbm5lY3Rpb25DYXBhYmlsaXRpZXMiLCJwcm92aWRlciIsImhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIiLCJoYXNHZXRWaWRlb0ZyYW1lRGF0YSIsInZpZGVvTm90U3VwcG9ydGVkQnlCcm93c2VyIiwiYWxpYXMiLCJ0ZW1wRmlsZXMiLCJ2aWRlb1JlY29yZGVyIiwiVmlkZW9SZWNvcmRlclByb2Nlc3MiLCJ0ZXN0UnVuQ29udHJvbGxlciIsInN0YXJ0Q2FwdHVyaW5nIiwiZmluaXNoQ2FwdHVyaW5nIiwidmlkZW9QYXRoIiwiZXJycyIsImxlbmd0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxlQUFlLHFCQUFNLHlCQUFOLENBQXJCOztBQUVBLE1BQU1DLGtCQUFrQixLQUF4Qjs7QUFFQSxNQUFNQyxrQkFBeUIsT0FBL0I7QUFDQSxNQUFNQyx5QkFBeUIsV0FBL0I7QUFDQSxNQUFNQyx5QkFBeUJELHlCQUF5QixRQUF4RDs7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QkFBTyxPQUFLQSxXQUFMLENBQWlCK0Qsa0JBQWtCdEMsS0FBbkMsQ0FBUDs7QUFFQSxrQkFBTXpCLFlBQVk2RCxhQUFaLENBQTBCSSxlQUExQixFQUFOOztBQUVBLGtCQUFNQyxZQUFZLE9BQUszQyxtQkFBTCxDQUF5QnZCLFdBQXpCLENBQWxCOztBQUVBLGdCQUFJLE9BQUtaLFVBQUwsSUFBbUIsQ0FBQzJFLGtCQUFrQnJDLE9BQWxCLENBQTBCeUMsSUFBMUIsQ0FBK0JDLE1BQXZELEVBQ0k7O0FBRUosa0JBQU0sdUJBQVEsbUJBQVFGLFNBQVIsQ0FBUixDQUFOOztBQUVBLGdCQUFJLE9BQUs3RSxVQUFULEVBQ0ksT0FBS3VELFlBQUwsQ0FBa0JzQixTQUFsQixFQUE2QmxFLFlBQVk0RCxTQUF6Qzs7QUFFSmQseUJBQUdHLFlBQUgsQ0FBZ0JqRCxZQUFZNEQsU0FBWixDQUFzQi9ELGFBQXRDLEVBQXFEcUUsU0FBckQ7QUFwQjJDO0FBcUI5QztBQXBLOEI7a0JBQWRyRixhIiwiZmlsZSI6InZpZGVvLXJlY29yZGVyL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IGpvaW4sIGRpcm5hbWUgfSBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBzcGF3blN5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBtYWtlRGlyIGZyb20gJ21ha2UtZGlyJztcbmltcG9ydCBWaWRlb1JlY29yZGVyUHJvY2VzcyBmcm9tICcuL3Byb2Nlc3MnO1xuaW1wb3J0IFRlbXBEaXJlY3RvcnkgZnJvbSAnLi4vdXRpbHMvdGVtcC1kaXJlY3RvcnknO1xuaW1wb3J0IFBhdGhQYXR0ZXJuIGZyb20gJy4uL3V0aWxzL3BhdGgtcGF0dGVybic7XG5pbXBvcnQgV0FSTklOR19NRVNTQUdFUyBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5pbXBvcnQgeyBnZXRQbHVyYWxTdWZmaXgsIGdldENvbmNhdGVuYXRlZFZhbHVlc1N0cmluZywgZ2V0VG9CZUluUGFzdFRlbnNlIH0gZnJvbSAnLi4vdXRpbHMvc3RyaW5nJztcblxuY29uc3QgREVCVUdfTE9HR0VSID0gZGVidWcoJ3Rlc3RjYWZlOnZpZGVvLXJlY29yZGVyJyk7XG5cbmNvbnN0IFZJREVPX0VYVEVOU0lPTiA9ICdtcDQnO1xuXG5jb25zdCBURU1QX0RJUl9QUkVGSVggICAgICAgID0gJ3ZpZGVvJztcbmNvbnN0IFRFTVBfVklERU9fRklMRV9QUkVGSVggPSAndG1wLXZpZGVvJztcbmNvbnN0IFRFTVBfTUVSR0VfRklMRV9QUkVGSVggPSBURU1QX1ZJREVPX0ZJTEVfUFJFRklYICsgJy1tZXJnZSc7XG5cbmNvbnN0IFRFTVBfTUVSR0VfQ09ORklHX0ZJTEVfUFJFRklYICAgID0gJ2NvbmZpZyc7XG5jb25zdCBURU1QX01FUkdFX0NPTkZJR19GSUxFX0VYVEVOU0lPTiA9ICd0eHQnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWaWRlb1JlY29yZGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoYnJvd3NlckpvYiwgYmFzZVBhdGgsIG9wdHMsIGVuY29kaW5nT3B0cywgd2FybmluZ0xvZykge1xuICAgICAgICB0aGlzLmJyb3dzZXJKb2IgICAgICAgID0gYnJvd3NlckpvYjtcbiAgICAgICAgdGhpcy5iYXNlUGF0aCAgICAgICAgICA9IGJhc2VQYXRoO1xuICAgICAgICB0aGlzLmZhaWxlZE9ubHkgICAgICAgID0gb3B0cy5mYWlsZWRPbmx5O1xuICAgICAgICB0aGlzLnNpbmdsZUZpbGUgICAgICAgID0gb3B0cy5zaW5nbGVGaWxlO1xuICAgICAgICB0aGlzLmZmbXBlZ1BhdGggICAgICAgID0gb3B0cy5mZm1wZWdQYXRoO1xuICAgICAgICB0aGlzLmN1c3RvbVBhdGhQYXR0ZXJuID0gb3B0cy5wYXRoUGF0dGVybjtcbiAgICAgICAgdGhpcy50aW1lU3RhbXAgICAgICAgICA9IG9wdHMudGltZVN0YW1wO1xuICAgICAgICB0aGlzLmVuY29kaW5nT3B0aW9ucyAgID0gZW5jb2RpbmdPcHRzO1xuXG4gICAgICAgIHRoaXMud2FybmluZ0xvZyA9IHdhcm5pbmdMb2c7XG5cbiAgICAgICAgdGhpcy50ZW1wRGlyZWN0b3J5ICAgICAgID0gbmV3IFRlbXBEaXJlY3RvcnkoVEVNUF9ESVJfUFJFRklYKTtcbiAgICAgICAgdGhpcy50ZW1wVmlkZW9QYXRoICAgICAgID0gJyc7XG4gICAgICAgIHRoaXMudGVtcE1lcmdlQ29uZmlnUGF0aCA9ICcnO1xuXG4gICAgICAgIHRoaXMuZmlyc3RGaWxlID0gdHJ1ZTtcblxuICAgICAgICB0aGlzLnRlc3RSdW5JbmZvID0ge307XG5cbiAgICAgICAgdGhpcy5fYXNzaWduRXZlbnRIYW5kbGVycyhicm93c2VySm9iKTtcbiAgICB9XG5cbiAgICBfY3JlYXRlU2FmZUxpc3RlbmVyIChsaXN0ZW5lcikge1xuICAgICAgICByZXR1cm4gYXN5bmMgKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgREVCVUdfTE9HR0VSKGxpc3RlbmVyICYmIGxpc3RlbmVyLm5hbWUsIGVycm9yKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2Fzc2lnbkV2ZW50SGFuZGxlcnMgKGJyb3dzZXJKb2IpIHtcbiAgICAgICAgYnJvd3NlckpvYi5vbmNlKCdzdGFydCcsIHRoaXMuX2NyZWF0ZVNhZmVMaXN0ZW5lcih0aGlzLl9vbkJyb3dzZXJKb2JTdGFydCkpO1xuICAgICAgICBicm93c2VySm9iLm9uY2UoJ2RvbmUnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25Ccm93c2VySm9iRG9uZSkpO1xuICAgICAgICBicm93c2VySm9iLm9uKCd0ZXN0LXJ1bi1jcmVhdGUnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25UZXN0UnVuQ3JlYXRlKSk7XG4gICAgICAgIGJyb3dzZXJKb2Iub24oJ3Rlc3QtcnVuLXJlYWR5JywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKHRoaXMuX29uVGVzdFJ1blJlYWR5KSk7XG4gICAgICAgIGJyb3dzZXJKb2Iub24oJ3Rlc3QtcnVuLWJlZm9yZS1kb25lJywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKHRoaXMuX29uVGVzdFJ1bkJlZm9yZURvbmUpKTtcbiAgICB9XG5cbiAgICBfYWRkUHJvYmxlbWF0aWNQbGFjZWhvbGRlcnNXYXJuaW5nIChwbGFjZWhvbGRlcnMpIHtcbiAgICAgICAgY29uc3QgcHJvYmxlbWF0aWNQbGFjZWhvbGRlckxpc3RTdHIgPSBnZXRDb25jYXRlbmF0ZWRWYWx1ZXNTdHJpbmcocGxhY2Vob2xkZXJzKTtcbiAgICAgICAgY29uc3Qgc3VmZml4ICAgICAgICAgICAgICAgICAgICAgICAgPSBnZXRQbHVyYWxTdWZmaXgocGxhY2Vob2xkZXJzKTtcbiAgICAgICAgY29uc3QgdmVyYiAgICAgICAgICAgICAgICAgICAgICAgICAgPSBnZXRUb0JlSW5QYXN0VGVuc2UocGxhY2Vob2xkZXJzKTtcblxuICAgICAgICB0aGlzLndhcm5pbmdMb2cuYWRkV2FybmluZyhXQVJOSU5HX01FU1NBR0VTLnByb2JsZW1hdGljUGF0aFBhdHRlcm5QbGFjZWhvbGRlckZvclZpZGVvUmVjb3JkaW5nLCBwcm9ibGVtYXRpY1BsYWNlaG9sZGVyTGlzdFN0ciwgc3VmZml4LCBzdWZmaXgsIHZlcmIpO1xuICAgIH1cblxuICAgIF9nZXRUYXJnZXRWaWRlb1BhdGggKHRlc3RSdW5JbmZvKSB7XG4gICAgICAgIGNvbnN0IHsgdGVzdCwgaW5kZXgsIHRlc3RSdW4gfSA9IHRlc3RSdW5JbmZvO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSB0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uO1xuXG4gICAgICAgIGNvbnN0IHBhdGhQYXR0ZXJuID0gbmV3IFBhdGhQYXR0ZXJuKHRoaXMuY3VzdG9tUGF0aFBhdHRlcm4sIFZJREVPX0VYVEVOU0lPTiwge1xuICAgICAgICAgICAgdGVzdEluZGV4OiAgICAgICAgIHRoaXMuc2luZ2xlRmlsZSA/IG51bGwgOiBpbmRleCxcbiAgICAgICAgICAgIHF1YXJhbnRpbmVBdHRlbXB0OiBudWxsLFxuICAgICAgICAgICAgbm93OiAgICAgICAgICAgICAgIHRoaXMudGltZVN0YW1wLFxuICAgICAgICAgICAgZml4dHVyZTogICAgICAgICAgIHRoaXMuc2luZ2xlRmlsZSA/IG51bGwgOiB0ZXN0LmZpeHR1cmUubmFtZSxcbiAgICAgICAgICAgIHRlc3Q6ICAgICAgICAgICAgICB0aGlzLnNpbmdsZUZpbGUgPyBudWxsIDogdGVzdC5uYW1lLFxuICAgICAgICAgICAgcGFyc2VkVXNlckFnZW50OiAgIGNvbm5lY3Rpb24uYnJvd3NlckluZm8ucGFyc2VkVXNlckFnZW50LFxuICAgICAgICB9KTtcblxuICAgICAgICBwYXRoUGF0dGVybi5vbigncHJvYmxlbWF0aWMtcGxhY2Vob2xkZXJzLWZvdW5kJywgKHsgcGxhY2Vob2xkZXJzIH0pID0+IHRoaXMuX2FkZFByb2JsZW1hdGljUGxhY2Vob2xkZXJzV2FybmluZyhwbGFjZWhvbGRlcnMpKTtcblxuICAgICAgICByZXR1cm4gam9pbih0aGlzLmJhc2VQYXRoLCBwYXRoUGF0dGVybi5nZXRQYXRoKCkpO1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZVRlbXBOYW1lcyAoaWQpIHtcbiAgICAgICAgY29uc3QgdGVtcEZpbGVOYW1lcyA9IHtcbiAgICAgICAgICAgIHRlbXBWaWRlb1BhdGg6ICAgICAgIGAke1RFTVBfVklERU9fRklMRV9QUkVGSVh9LSR7aWR9LiR7VklERU9fRVhURU5TSU9OfWAsXG4gICAgICAgICAgICB0ZW1wTWVyZ2VDb25maWdQYXRoOiBgJHtURU1QX01FUkdFX0NPTkZJR19GSUxFX1BSRUZJWH0tJHtpZH0uJHtURU1QX01FUkdFX0NPTkZJR19GSUxFX0VYVEVOU0lPTn1gLFxuICAgICAgICAgICAgdG1wTWVyZ2VOYW1lOiAgICAgICAgYCR7VEVNUF9NRVJHRV9GSUxFX1BSRUZJWH0tJHtpZH0uJHtWSURFT19FWFRFTlNJT059YFxuICAgICAgICB9O1xuXG4gICAgICAgIGZvciAoY29uc3QgW3RlbXBGaWxlLCB0ZW1wTmFtZV0gb2YgT2JqZWN0LmVudHJpZXModGVtcEZpbGVOYW1lcykpXG4gICAgICAgICAgICB0ZW1wRmlsZU5hbWVzW3RlbXBGaWxlXSA9IGpvaW4odGhpcy50ZW1wRGlyZWN0b3J5LnBhdGgsIHRlbXBOYW1lKTtcblxuICAgICAgICByZXR1cm4gdGVtcEZpbGVOYW1lcztcbiAgICB9XG5cbiAgICBfY29uY2F0VmlkZW8gKHRhcmdldFZpZGVvUGF0aCwgeyB0ZW1wVmlkZW9QYXRoLCB0ZW1wTWVyZ2VDb25maWdQYXRoLCB0bXBNZXJnZU5hbWUgfSkge1xuICAgICAgICBpZiAodGhpcy5maXJzdEZpbGUpIHtcbiAgICAgICAgICAgIHRoaXMuZmlyc3RGaWxlID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHRlbXBNZXJnZUNvbmZpZ1BhdGgsIGBcbiAgICAgICAgICAgIGZpbGUgJyR7dGFyZ2V0VmlkZW9QYXRofSdcbiAgICAgICAgICAgIGZpbGUgJyR7dGVtcFZpZGVvUGF0aH0nXG4gICAgICAgIGApO1xuXG4gICAgICAgIHNwYXduU3luYyh0aGlzLmZmbXBlZ1BhdGgsIFsnLXknLCAnLWYnLCAnY29uY2F0JywgJy1zYWZlJywgJzAnLCAnLWknLCB0ZW1wTWVyZ2VDb25maWdQYXRoLCAnLWMnLCAnY29weScsIHRtcE1lcmdlTmFtZV0sIHsgc3RkaW86ICdpZ25vcmUnIH0pO1xuICAgICAgICBmcy5jb3B5RmlsZVN5bmModG1wTWVyZ2VOYW1lLCB0ZW1wVmlkZW9QYXRoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25Ccm93c2VySm9iU3RhcnQgKCkge1xuICAgICAgICBhd2FpdCB0aGlzLnRlbXBEaXJlY3RvcnkuaW5pdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vbkJyb3dzZXJKb2JEb25lICgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy50ZW1wRGlyZWN0b3J5LmRpc3Bvc2UoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25UZXN0UnVuQ3JlYXRlICh7IHRlc3RSdW4sIGxlZ2FjeSwgcXVhcmFudGluZSwgdGVzdCwgaW5kZXggfSkge1xuICAgICAgICBpZiAobGVnYWN5KVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHRlc3RSdW5JbmZvID0geyB0ZXN0UnVuLCBxdWFyYW50aW5lLCB0ZXN0LCBpbmRleCB9O1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSB0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25DYXBhYmlsaXRpZXMgPSBhd2FpdCB0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLnByb3ZpZGVyLmhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIoY29ubmVjdGlvbi5pZCk7XG5cbiAgICAgICAgaWYgKCFjb25uZWN0aW9uQ2FwYWJpbGl0aWVzIHx8ICFjb25uZWN0aW9uQ2FwYWJpbGl0aWVzLmhhc0dldFZpZGVvRnJhbWVEYXRhKSB7XG4gICAgICAgICAgICB0aGlzLmJyb3dzZXJKb2Iud2FybmluZ0xvZy5hZGRXYXJuaW5nKFdBUk5JTkdfTUVTU0FHRVMudmlkZW9Ob3RTdXBwb3J0ZWRCeUJyb3dzZXIsIGNvbm5lY3Rpb24uYnJvd3NlckluZm8uYWxpYXMpO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnRlc3RSdW5JbmZvW2luZGV4XSA9IHRlc3RSdW5JbmZvO1xuXG4gICAgICAgIHRlc3RSdW5JbmZvLnRlbXBGaWxlcyA9IHRoaXMuX2dlbmVyYXRlVGVtcE5hbWVzKGNvbm5lY3Rpb24uaWQpO1xuXG5cbiAgICAgICAgdGVzdFJ1bkluZm8udmlkZW9SZWNvcmRlciA9IG5ldyBWaWRlb1JlY29yZGVyUHJvY2Vzcyh0ZXN0UnVuSW5mby50ZW1wRmlsZXMudGVtcFZpZGVvUGF0aCwgdGhpcy5mZm1wZWdQYXRoLCBjb25uZWN0aW9uLCB0aGlzLmVuY29kaW5nT3B0aW9ucyk7XG5cbiAgICAgICAgYXdhaXQgdGVzdFJ1bkluZm8udmlkZW9SZWNvcmRlci5pbml0KCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX29uVGVzdFJ1blJlYWR5ICh0ZXN0UnVuQ29udHJvbGxlcikge1xuICAgICAgICBjb25zdCB0ZXN0UnVuSW5mbyA9IHRoaXMudGVzdFJ1bkluZm9bdGVzdFJ1bkNvbnRyb2xsZXIuaW5kZXhdO1xuXG4gICAgICAgIGlmICghdGVzdFJ1bkluZm8pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgYXdhaXQgdGVzdFJ1bkluZm8udmlkZW9SZWNvcmRlci5zdGFydENhcHR1cmluZygpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vblRlc3RSdW5CZWZvcmVEb25lICh0ZXN0UnVuQ29udHJvbGxlcikge1xuICAgICAgICBjb25zdCB0ZXN0UnVuSW5mbyA9IHRoaXMudGVzdFJ1bkluZm9bdGVzdFJ1bkNvbnRyb2xsZXIuaW5kZXhdO1xuXG4gICAgICAgIGlmICghdGVzdFJ1bkluZm8pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgZGVsZXRlIHRoaXMudGVzdFJ1bkluZm9bdGVzdFJ1bkNvbnRyb2xsZXIuaW5kZXhdO1xuXG4gICAgICAgIGF3YWl0IHRlc3RSdW5JbmZvLnZpZGVvUmVjb3JkZXIuZmluaXNoQ2FwdHVyaW5nKCk7XG5cbiAgICAgICAgY29uc3QgdmlkZW9QYXRoID0gdGhpcy5fZ2V0VGFyZ2V0VmlkZW9QYXRoKHRlc3RSdW5JbmZvKTtcblxuICAgICAgICBpZiAodGhpcy5mYWlsZWRPbmx5ICYmICF0ZXN0UnVuQ29udHJvbGxlci50ZXN0UnVuLmVycnMubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IG1ha2VEaXIoZGlybmFtZSh2aWRlb1BhdGgpKTtcblxuICAgICAgICBpZiAodGhpcy5zaW5nbGVGaWxlKVxuICAgICAgICAgICAgdGhpcy5fY29uY2F0VmlkZW8odmlkZW9QYXRoLCB0ZXN0UnVuSW5mby50ZW1wRmlsZXMpO1xuXG4gICAgICAgIGZzLmNvcHlGaWxlU3luYyh0ZXN0UnVuSW5mby50ZW1wRmlsZXMudGVtcFZpZGVvUGF0aCwgdmlkZW9QYXRoKTtcbiAgICB9XG59XG4iXX0=
