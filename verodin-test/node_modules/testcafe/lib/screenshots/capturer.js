'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _testcafeBrowserTools = require('testcafe-browser-tools');

var _crop = require('./crop');

var _makeDir = require('make-dir');

var _makeDir2 = _interopRequireDefault(_makeDir);

var _asyncQueue = require('../utils/async-queue');

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

var _escapeUserAgent = require('../utils/escape-user-agent');

var _escapeUserAgent2 = _interopRequireDefault(_escapeUserAgent);

var _correctFilePath = require('../utils/correct-file-path');

var _correctFilePath2 = _interopRequireDefault(_correctFilePath);

var _promisifiedFunctions = require('../utils/promisified-functions');

var _utils = require('./utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Capturer {
    constructor(baseScreenshotsPath, testEntry, connection, pathPattern, warningLog) {
        this.enabled = !!baseScreenshotsPath;
        this.baseScreenshotsPath = baseScreenshotsPath;
        this.testEntry = testEntry;
        this.provider = connection.provider;
        this.browserId = connection.id;
        this.warningLog = warningLog;
        this.pathPattern = pathPattern;
    }

    static _getDimensionWithoutScrollbar(fullDimension, documentDimension, bodyDimension) {
        if (bodyDimension > fullDimension) return documentDimension;

        if (documentDimension > fullDimension) return bodyDimension;

        return Math.max(documentDimension, bodyDimension);
    }

    static _getCropDimensions(cropDimensions, pageDimensions) {
        if (!cropDimensions || !pageDimensions) return null;

        const dpr = pageDimensions.dpr;
        const top = cropDimensions.top,
              left = cropDimensions.left,
              bottom = cropDimensions.bottom,
              right = cropDimensions.right;


        return {
            top: Math.round(top * dpr),
            left: Math.round(left * dpr),
            bottom: Math.round(bottom * dpr),
            right: Math.round(right * dpr)
        };
    }

    static _getClientAreaDimensions(pageDimensions) {
        if (!pageDimensions) return null;

        const innerWidth = pageDimensions.innerWidth,
              documentWidth = pageDimensions.documentWidth,
              bodyWidth = pageDimensions.bodyWidth,
              innerHeight = pageDimensions.innerHeight,
              documentHeight = pageDimensions.documentHeight,
              bodyHeight = pageDimensions.bodyHeight,
              dpr = pageDimensions.dpr;


        return {
            width: Math.floor(Capturer._getDimensionWithoutScrollbar(innerWidth, documentWidth, bodyWidth) * dpr),
            height: Math.floor(Capturer._getDimensionWithoutScrollbar(innerHeight, documentHeight, bodyHeight) * dpr)
        };
    }

    static _isScreenshotCaptured(screenshotPath) {
        return (0, _asyncToGenerator3.default)(function* () {
            try {
                const stats = yield (0, _promisifiedFunctions.stat)(screenshotPath);

                return stats.isFile();
            } catch (e) {
                return false;
            }
        })();
    }

    _joinWithBaseScreenshotPath(path) {
        return (0, _path.join)(this.baseScreenshotsPath, path);
    }

    _incrementFileIndexes(forError) {
        if (forError) this.pathPattern.data.errorFileIndex++;else this.pathPattern.data.fileIndex++;
    }

    _getCustomScreenshotPath(customPath) {
        const correctedCustomPath = (0, _correctFilePath2.default)(customPath);

        return this._joinWithBaseScreenshotPath(correctedCustomPath);
    }

    _getScreenshotPath(forError) {
        const path = this.pathPattern.getPath(forError);

        this._incrementFileIndexes(forError);

        return this._joinWithBaseScreenshotPath(path);
    }

    _getThumbnailPath(screenshotPath) {
        const imageName = (0, _path.basename)(screenshotPath);
        const imageDir = (0, _path.dirname)(screenshotPath);

        return (0, _path.join)(imageDir, 'thumbnails', imageName);
    }

    _takeScreenshot(filePath, pageWidth, pageHeight) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield (0, _makeDir2.default)((0, _path.dirname)(filePath));
            yield _this.provider.takeScreenshot(_this.browserId, filePath, pageWidth, pageHeight);
        })();
    }

    _capture(forError, { pageDimensions, cropDimensions, markSeed, customPath } = {}) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this2.enabled) return null;

            const screenshotPath = customPath ? _this2._getCustomScreenshotPath(customPath) : _this2._getScreenshotPath(forError);
            const thumbnailPath = _this2._getThumbnailPath(screenshotPath);

            if ((0, _asyncQueue.isInQueue)(screenshotPath)) _this2.warningLog.addWarning(_warningMessage2.default.screenshotRewritingError, screenshotPath);

            yield (0, _asyncQueue.addToQueue)(screenshotPath, (0, _asyncToGenerator3.default)(function* () {
                yield _this2._takeScreenshot(screenshotPath, ...(pageDimensions ? [pageDimensions.innerWidth, pageDimensions.innerHeight] : []));

                if (!(yield Capturer._isScreenshotCaptured(screenshotPath))) return;

                try {
                    const binaryImage = yield (0, _promisifiedFunctions.readFile)(screenshotPath);

                    const croppedImage = yield (0, _crop.cropScreenshot)(screenshotPath, markSeed, Capturer._getClientAreaDimensions(pageDimensions), Capturer._getCropDimensions(cropDimensions, pageDimensions), binaryImage);

                    if (croppedImage) yield (0, _utils.writePng)(screenshotPath, croppedImage);
                } catch (err) {
                    yield (0, _promisifiedFunctions.deleteFile)(screenshotPath);

                    throw err;
                }

                yield (0, _testcafeBrowserTools.generateThumbnail)(screenshotPath, thumbnailPath);
            }));

            const screenshot = {
                screenshotPath,
                thumbnailPath,
                userAgent: (0, _escapeUserAgent2.default)(_this2.pathPattern.data.parsedUserAgent),
                quarantineAttempt: _this2.pathPattern.data.quarantineAttempt,
                takenOnFail: forError
            };

            _this2.testEntry.screenshots.push(screenshot);

            return screenshotPath;
        })();
    }

    captureAction(options) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this3._capture(false, options);
        })();
    }

    captureError(options) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this4._capture(true, options);
        })();
    }
}
exports.default = Capturer;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JlZW5zaG90cy9jYXB0dXJlci5qcyJdLCJuYW1lcyI6WyJDYXB0dXJlciIsImNvbnN0cnVjdG9yIiwiYmFzZVNjcmVlbnNob3RzUGF0aCIsInRlc3RFbnRyeSIsImNvbm5lY3Rpb24iLCJwYXRoUGF0dGVybiIsIndhcm5pbmdMb2ciLCJlbmFibGVkIiwicHJvdmlkZXIiLCJicm93c2VySWQiLCJpZCIsIl9nZXREaW1lbnNpb25XaXRob3V0U2Nyb2xsYmFyIiwiZnVsbERpbWVuc2lvbiIsImRvY3VtZW50RGltZW5zaW9uIiwiYm9keURpbWVuc2lvbiIsIk1hdGgiLCJtYXgiLCJfZ2V0Q3JvcERpbWVuc2lvbnMiLCJjcm9wRGltZW5zaW9ucyIsInBhZ2VEaW1lbnNpb25zIiwiZHByIiwidG9wIiwibGVmdCIsImJvdHRvbSIsInJpZ2h0Iiwicm91bmQiLCJfZ2V0Q2xpZW50QXJlYURpbWVuc2lvbnMiLCJpbm5lcldpZHRoIiwiZG9jdW1lbnRXaWR0aCIsImJvZHlXaWR0aCIsImlubmVySGVpZ2h0IiwiZG9jdW1lbnRIZWlnaHQiLCJib2R5SGVpZ2h0Iiwid2lkdGgiLCJmbG9vciIsImhlaWdodCIsIl9pc1NjcmVlbnNob3RDYXB0dXJlZCIsInNjcmVlbnNob3RQYXRoIiwic3RhdHMiLCJpc0ZpbGUiLCJlIiwiX2pvaW5XaXRoQmFzZVNjcmVlbnNob3RQYXRoIiwicGF0aCIsIl9pbmNyZW1lbnRGaWxlSW5kZXhlcyIsImZvckVycm9yIiwiZGF0YSIsImVycm9yRmlsZUluZGV4IiwiZmlsZUluZGV4IiwiX2dldEN1c3RvbVNjcmVlbnNob3RQYXRoIiwiY3VzdG9tUGF0aCIsImNvcnJlY3RlZEN1c3RvbVBhdGgiLCJfZ2V0U2NyZWVuc2hvdFBhdGgiLCJnZXRQYXRoIiwiX2dldFRodW1ibmFpbFBhdGgiLCJpbWFnZU5hbWUiLCJpbWFnZURpciIsIl90YWtlU2NyZWVuc2hvdCIsImZpbGVQYXRoIiwicGFnZVdpZHRoIiwicGFnZUhlaWdodCIsInRha2VTY3JlZW5zaG90IiwiX2NhcHR1cmUiLCJtYXJrU2VlZCIsInRodW1ibmFpbFBhdGgiLCJhZGRXYXJuaW5nIiwiV0FSTklOR19NRVNTQUdFIiwic2NyZWVuc2hvdFJld3JpdGluZ0Vycm9yIiwiYmluYXJ5SW1hZ2UiLCJjcm9wcGVkSW1hZ2UiLCJlcnIiLCJzY3JlZW5zaG90IiwidXNlckFnZW50IiwicGFyc2VkVXNlckFnZW50IiwicXVhcmFudGluZUF0dGVtcHQiLCJ0YWtlbk9uRmFpbCIsInNjcmVlbnNob3RzIiwicHVzaCIsImNhcHR1cmVBY3Rpb24iLCJvcHRpb25zIiwiY2FwdHVyZUVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFFZSxNQUFNQSxRQUFOLENBQWU7QUFDMUJDLGdCQUFhQyxtQkFBYixFQUFrQ0MsU0FBbEMsRUFBNkNDLFVBQTdDLEVBQXlEQyxXQUF6RCxFQUFzRUMsVUFBdEUsRUFBa0Y7QUFDOUUsYUFBS0MsT0FBTCxHQUEyQixDQUFDLENBQUNMLG1CQUE3QjtBQUNBLGFBQUtBLG1CQUFMLEdBQTJCQSxtQkFBM0I7QUFDQSxhQUFLQyxTQUFMLEdBQTJCQSxTQUEzQjtBQUNBLGFBQUtLLFFBQUwsR0FBMkJKLFdBQVdJLFFBQXRDO0FBQ0EsYUFBS0MsU0FBTCxHQUEyQkwsV0FBV00sRUFBdEM7QUFDQSxhQUFLSixVQUFMLEdBQTJCQSxVQUEzQjtBQUNBLGFBQUtELFdBQUwsR0FBMkJBLFdBQTNCO0FBQ0g7O0FBRUQsV0FBT00sNkJBQVAsQ0FBc0NDLGFBQXRDLEVBQXFEQyxpQkFBckQsRUFBd0VDLGFBQXhFLEVBQXVGO0FBQ25GLFlBQUlBLGdCQUFnQkYsYUFBcEIsRUFDSSxPQUFPQyxpQkFBUDs7QUFFSixZQUFJQSxvQkFBb0JELGFBQXhCLEVBQ0ksT0FBT0UsYUFBUDs7QUFFSixlQUFPQyxLQUFLQyxHQUFMLENBQVNILGlCQUFULEVBQTRC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O0FBQzFCLG1CQUFPLE1BQU0sT0FBS2pCLFFBQUwsQ0FBYyxLQUFkLEVBQXFCaUIsT0FBckIsQ0FBYjtBQUQwQjtBQUU3Qjs7QUFFS0MsZ0JBQU4sQ0FBb0JELE9BQXBCLEVBQTZCO0FBQUE7O0FBQUE7QUFDekIsbUJBQU8sTUFBTSxPQUFLakIsUUFBTCxDQUFjLElBQWQsRUFBb0JpQixPQUFwQixDQUFiO0FBRHlCO0FBRTVCO0FBM0p5QjtrQkFBVDlFLFEiLCJmaWxlIjoic2NyZWVuc2hvdHMvY2FwdHVyZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqb2luIGFzIGpvaW5QYXRoLCBkaXJuYW1lLCBiYXNlbmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZ2VuZXJhdGVUaHVtYm5haWwgfSBmcm9tICd0ZXN0Y2FmZS1icm93c2VyLXRvb2xzJztcbmltcG9ydCB7IGNyb3BTY3JlZW5zaG90IH0gZnJvbSAnLi9jcm9wJztcbmltcG9ydCBtYWtlRGlyIGZyb20gJ21ha2UtZGlyJztcbmltcG9ydCB7IGlzSW5RdWV1ZSwgYWRkVG9RdWV1ZSB9IGZyb20gJy4uL3V0aWxzL2FzeW5jLXF1ZXVlJztcbmltcG9ydCBXQVJOSU5HX01FU1NBR0UgZnJvbSAnLi4vbm90aWZpY2F0aW9ucy93YXJuaW5nLW1lc3NhZ2UnO1xuaW1wb3J0IGVzY2FwZVVzZXJBZ2VudCBmcm9tICcuLi91dGlscy9lc2NhcGUtdXNlci1hZ2VudCc7XG5pbXBvcnQgY29ycmVjdEZpbGVQYXRoIGZyb20gJy4uL3V0aWxzL2NvcnJlY3QtZmlsZS1wYXRoJztcbmltcG9ydCB7IHJlYWRGaWxlLCBkZWxldGVGaWxlLCBzdGF0IH0gZnJvbSAnLi4vdXRpbHMvcHJvbWlzaWZpZWQtZnVuY3Rpb25zJztcbmltcG9ydCB7IHdyaXRlUG5nIH0gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENhcHR1cmVyIHtcbiAgICBjb25zdHJ1Y3RvciAoYmFzZVNjcmVlbnNob3RzUGF0aCwgdGVzdEVudHJ5LCBjb25uZWN0aW9uLCBwYXRoUGF0dGVybiwgd2FybmluZ0xvZykge1xuICAgICAgICB0aGlzLmVuYWJsZWQgICAgICAgICAgICAgPSAhIWJhc2VTY3JlZW5zaG90c1BhdGg7XG4gICAgICAgIHRoaXMuYmFzZVNjcmVlbnNob3RzUGF0aCA9IGJhc2VTY3JlZW5zaG90c1BhdGg7XG4gICAgICAgIHRoaXMudGVzdEVudHJ5ICAgICAgICAgICA9IHRlc3RFbnRyeTtcbiAgICAgICAgdGhpcy5wcm92aWRlciAgICAgICAgICAgID0gY29ubmVjdGlvbi5wcm92aWRlcjtcbiAgICAgICAgdGhpcy5icm93c2VySWQgICAgICAgICAgID0gY29ubmVjdGlvbi5pZDtcbiAgICAgICAgdGhpcy53YXJuaW5nTG9nICAgICAgICAgID0gd2FybmluZ0xvZztcbiAgICAgICAgdGhpcy5wYXRoUGF0dGVybiAgICAgICAgID0gcGF0aFBhdHRlcm47XG4gICAgfVxuXG4gICAgc3RhdGljIF9nZXREaW1lbnNpb25XaXRob3V0U2Nyb2xsYmFyIChmdWxsRGltZW5zaW9uLCBkb2N1bWVudERpbWVuc2lvbiwgYm9keURpbWVuc2lvbikge1xuICAgICAgICBpZiAoYm9keURpbWVuc2lvbiA+IGZ1bGxEaW1lbnNpb24pXG4gICAgICAgICAgICByZXR1cm4gZG9jdW1lbnREaW1lbnNpb247XG5cbiAgICAgICAgaWYgKGRvY3VtZW50RGltZW5zaW9uID4gZnVsbERpbWVuc2lvbilcbiAgICAgICAgICAgIHJldHVybiBib2R5RGltZW5zaW9uO1xuXG4gICAgICAgIHJldHVybiBNYXRoLm1heChkb2N1bWVudERpbWVuc2lvbiwgYm9keURpbWVuc2lvbik7XG4gICAgfVxuXG4gICAgc3RhdGljIF9nZXRDcm9wRGltZW5zaW9ucyAoY3JvcERpbWVuc2lvbnMsIHBhZ2VEaW1lbnNpb25zKSB7XG4gICAgICAgIGlmICghY3JvcERpbWVuc2lvbnMgfHwgIXBhZ2VEaW1lbnNpb25zKVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgY29uc3QgeyBkcHIgfSAgICAgICAgICAgICAgICAgICAgICA9IHBhZ2VEaW1lbnNpb25zO1xuICAgICAgICBjb25zdCB7IHRvcCwgbGVmdCwgYm90dG9tLCByaWdodCB9ID0gY3JvcERpbWVuc2lvbnM7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRvcDogICAgTWF0aC5yb3VuZCh0b3AgKiBkcHIpLFxuICAgICAgICAgICAgbGVmdDogICBNYXRoLnJvdW5kKGxlZnQgKiBkcHIpLFxuICAgICAgICAgICAgYm90dG9tOiBNYXRoLnJvdW5kKGJvdHRvbSAqIGRwciksXG4gICAgICAgICAgICByaWdodDogIE1hdGgucm91bmQocmlnaHQgKiBkcHIpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgc3RhdGljIF9nZXRDbGllbnRBcmVhRGltZW5zaW9ucyAocGFnZURpbWVuc2lvbnMpIHtcbiAgICAgICAgaWYgKCFwYWdlRGltZW5zaW9ucylcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IHsgaW5uZXJXaWR0aCwgZG9jdW1lbnRXaWR0aCwgYm9keVdpZHRoLCBpbm5lckhlaWdodCwgZG9jdW1lbnRIZWlnaHQsIGJvZHlIZWlnaHQsIGRwciB9ID0gcGFnZURpbWVuc2lvbnM7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHdpZHRoOiAgTWF0aC5mbG9vcihDYXB0dXJlci5fZ2V0RGltZW5zaW9uV2l0aG91dFNjcm9sbGJhcihpbm5lcldpZHRoLCBkb2N1bWVudFdpZHRoLCBib2R5V2lkdGgpICogZHByKSxcbiAgICAgICAgICAgIGhlaWdodDogTWF0aC5mbG9vcihDYXB0dXJlci5fZ2V0RGltZW5zaW9uV2l0aG91dFNjcm9sbGJhcihpbm5lckhlaWdodCwgZG9jdW1lbnRIZWlnaHQsIGJvZHlIZWlnaHQpICogZHByKVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBfaXNTY3JlZW5zaG90Q2FwdHVyZWQgKHNjcmVlbnNob3RQYXRoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0cyA9IGF3YWl0IHN0YXQoc2NyZWVuc2hvdFBhdGgpO1xuXG4gICAgICAgICAgICByZXR1cm4gc3RhdHMuaXNGaWxlKCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9qb2luV2l0aEJhc2VTY3JlZW5zaG90UGF0aCAocGF0aCkge1xuICAgICAgICByZXR1cm4gam9pblBhdGgodGhpcy5iYXNlU2NyZWVuc2hvdHNQYXRoLCBwYXRoKTtcbiAgICB9XG5cbiAgICBfaW5jcmVtZW50RmlsZUluZGV4ZXMgKGZvckVycm9yKSB7XG4gICAgICAgIGlmIChmb3JFcnJvcilcbiAgICAgICAgICAgIHRoaXMucGF0aFBhdHRlcm4uZGF0YS5lcnJvckZpbGVJbmRleCsrO1xuXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHRoaXMucGF0aFBhdHRlcm4uZGF0YS5maWxlSW5kZXgrKztcbiAgICB9XG5cbiAgICBfZ2V0Q3VzdG9tU2NyZWVuc2hvdFBhdGggKGN1c3RvbVBhdGgpIHtcbiAgICAgICAgY29uc3QgY29ycmVjdGVkQ3VzdG9tUGF0aCA9IGNvcnJlY3RGaWxlUGF0aChjdXN0b21QYXRoKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fam9pbldpdGhCYXNlU2NyZWVuc2hvdFBhdGgoY29ycmVjdGVkQ3VzdG9tUGF0aCk7XG4gICAgfVxuXG4gICAgX2dldFNjcmVlbnNob3RQYXRoIChmb3JFcnJvcikge1xuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5wYXRoUGF0dGVybi5nZXRQYXRoKGZvckVycm9yKTtcblxuICAgICAgICB0aGlzLl9pbmNyZW1lbnRGaWxlSW5kZXhlcyhmb3JFcnJvcik7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2pvaW5XaXRoQmFzZVNjcmVlbnNob3RQYXRoKHBhdGgpO1xuICAgIH1cblxuICAgIF9nZXRUaHVtYm5haWxQYXRoIChzY3JlZW5zaG90UGF0aCkge1xuICAgICAgICBjb25zdCBpbWFnZU5hbWUgPSBiYXNlbmFtZShzY3JlZW5zaG90UGF0aCk7XG4gICAgICAgIGNvbnN0IGltYWdlRGlyICA9IGRpcm5hbWUoc2NyZWVuc2hvdFBhdGgpO1xuXG4gICAgICAgIHJldHVybiBqb2luUGF0aChpbWFnZURpciwgJ3RodW1ibmFpbHMnLCBpbWFnZU5hbWUpO1xuICAgIH1cblxuICAgIGFzeW5jIF90YWtlU2NyZWVuc2hvdCAoZmlsZVBhdGgsIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCkge1xuICAgICAgICBhd2FpdCBtYWtlRGlyKGRpcm5hbWUoZmlsZVBhdGgpKTtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm92aWRlci50YWtlU2NyZWVuc2hvdCh0aGlzLmJyb3dzZXJJZCwgZmlsZVBhdGgsIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2NhcHR1cmUgKGZvckVycm9yLCB7IHBhZ2VEaW1lbnNpb25zLCBjcm9wRGltZW5zaW9ucywgbWFya1NlZWQsIGN1c3RvbVBhdGggfSA9IHt9KSB7XG4gICAgICAgIGlmICghdGhpcy5lbmFibGVkKVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgY29uc3Qgc2NyZWVuc2hvdFBhdGggPSBjdXN0b21QYXRoID8gdGhpcy5fZ2V0Q3VzdG9tU2NyZWVuc2hvdFBhdGgoY3VzdG9tUGF0aCkgOiB0aGlzLl9nZXRTY3JlZW5zaG90UGF0aChmb3JFcnJvcik7XG4gICAgICAgIGNvbnN0IHRodW1ibmFpbFBhdGggID0gdGhpcy5fZ2V0VGh1bWJuYWlsUGF0aChzY3JlZW5zaG90UGF0aCk7XG5cbiAgICAgICAgaWYgKGlzSW5RdWV1ZShzY3JlZW5zaG90UGF0aCkpXG4gICAgICAgICAgICB0aGlzLndhcm5pbmdMb2cuYWRkV2FybmluZyhXQVJOSU5HX01FU1NBR0Uuc2NyZWVuc2hvdFJld3JpdGluZ0Vycm9yLCBzY3JlZW5zaG90UGF0aCk7XG5cbiAgICAgICAgYXdhaXQgYWRkVG9RdWV1ZShzY3JlZW5zaG90UGF0aCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5fdGFrZVNjcmVlbnNob3Qoc2NyZWVuc2hvdFBhdGgsIC4uLiBwYWdlRGltZW5zaW9ucyA/IFtwYWdlRGltZW5zaW9ucy5pbm5lcldpZHRoLCBwYWdlRGltZW5zaW9ucy5pbm5lckhlaWdodF0gOiBbXSk7XG5cbiAgICAgICAgICAgIGlmICghYXdhaXQgQ2FwdHVyZXIuX2lzU2NyZWVuc2hvdENhcHR1cmVkKHNjcmVlbnNob3RQYXRoKSlcbiAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYmluYXJ5SW1hZ2UgPSBhd2FpdCByZWFkRmlsZShzY3JlZW5zaG90UGF0aCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjcm9wcGVkSW1hZ2UgPSBhd2FpdCBjcm9wU2NyZWVuc2hvdChcbiAgICAgICAgICAgICAgICAgICAgc2NyZWVuc2hvdFBhdGgsXG4gICAgICAgICAgICAgICAgICAgIG1hcmtTZWVkLFxuICAgICAgICAgICAgICAgICAgICBDYXB0dXJlci5fZ2V0Q2xpZW50QXJlYURpbWVuc2lvbnMocGFnZURpbWVuc2lvbnMpLFxuICAgICAgICAgICAgICAgICAgICBDYXB0dXJlci5fZ2V0Q3JvcERpbWVuc2lvbnMoY3JvcERpbWVuc2lvbnMsIHBhZ2VEaW1lbnNpb25zKSxcbiAgICAgICAgICAgICAgICAgICAgYmluYXJ5SW1hZ2VcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgaWYgKGNyb3BwZWRJbWFnZSlcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgd3JpdGVQbmcoc2NyZWVuc2hvdFBhdGgsIGNyb3BwZWRJbWFnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZGVsZXRlRmlsZShzY3JlZW5zaG90UGF0aCk7XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGF3YWl0IGdlbmVyYXRlVGh1bWJuYWlsKHNjcmVlbnNob3RQYXRoLCB0aHVtYm5haWxQYXRoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc2NyZWVuc2hvdCA9IHtcbiAgICAgICAgICAgIHNjcmVlbnNob3RQYXRoLFxuICAgICAgICAgICAgdGh1bWJuYWlsUGF0aCxcbiAgICAgICAgICAgIHVzZXJBZ2VudDogICAgICAgICBlc2NhcGVVc2VyQWdlbnQodGhpcy5wYXRoUGF0dGVybi5kYXRhLnBhcnNlZFVzZXJBZ2VudCksXG4gICAgICAgICAgICBxdWFyYW50aW5lQXR0ZW1wdDogdGhpcy5wYXRoUGF0dGVybi5kYXRhLnF1YXJhbnRpbmVBdHRlbXB0LFxuICAgICAgICAgICAgdGFrZW5PbkZhaWw6ICAgICAgIGZvckVycm9yLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMudGVzdEVudHJ5LnNjcmVlbnNob3RzLnB1c2goc2NyZWVuc2hvdCk7XG5cbiAgICAgICAgcmV0dXJuIHNjcmVlbnNob3RQYXRoO1xuICAgIH1cblxuICAgIGFzeW5jIGNhcHR1cmVBY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2NhcHR1cmUoZmFsc2UsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIGNhcHR1cmVFcnJvciAob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY2FwdHVyZSh0cnVlLCBvcHRpb25zKTtcbiAgICB9XG59XG5cbiJdfQ==
