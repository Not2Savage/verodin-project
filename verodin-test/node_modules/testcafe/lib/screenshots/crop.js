'use strict';

exports.__esModule = true;
exports.cropScreenshot = undefined;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let cropScreenshot = exports.cropScreenshot = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (path, markSeed, clientAreaDimensions, cropDimensions, binaryImage) {
        if (!markSeed && !cropDimensions) return null;

        const pngImage = yield (0, _utils.readPng)(binaryImage);
        const clip = calculateClipInfo(pngImage, path, markSeed, clientAreaDimensions, cropDimensions);

        return (0, _utils.copyImagePart)(pngImage, clip);
    });

    return function cropScreenshot(_x, _x2, _x3, _x4, _x5) {
        return _ref.apply(this, arguments);
    };
})();

exports.calculateMarkPosition = calculateMarkPosition;
exports.getClipInfoByMarkPosition = getClipInfoByMarkPosition;
exports.getClipInfoByCropDimensions = getClipInfoByCropDimensions;
exports.calculateClipInfo = calculateClipInfo;

var _utils = require('./utils');

var _limitNumber = require('../utils/limit-number');

var _limitNumber2 = _interopRequireDefault(_limitNumber);

var _renderTemplate = require('../utils/render-template');

var _renderTemplate2 = _interopRequireDefault(_renderTemplate);

var _testRun = require('../errors/test-run/');

var _constants = require('./constants');

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function markSeedToId(markSeed) {
    let id = 0;

    for (let i = 0; i < _constants.MARK_LENGTH; i++) id = id * 2 + (markSeed[i * _constants.MARK_BYTES_PER_PIXEL] ? 1 : 0);

    return id;
}

function calculateMarkPosition(pngImage, markSeed) {
    const mark = Buffer.from(markSeed);
    const markIndex = pngImage.data.indexOf(mark);

    if (markIndex < 0) return null;

    const endPosition = markIndex / _constants.MARK_BYTES_PER_PIXEL + _constants.MARK_LENGTH + _constants.MARK_RIGHT_MARGIN;

    const x = endPosition % pngImage.width || pngImage.width;
    const y = (endPosition - x) / pngImage.width + 1;

    return { x, y };
}

function getClipInfoByMarkPosition(markPosition, { width, height }) {
    const x = markPosition.x,
          y = markPosition.y;


    const clipRight = x;
    const clipBottom = y;
    const clipLeft = clipRight - width;
    const clipTop = clipBottom - height;

    return {
        clipLeft,
        clipTop,
        clipRight,
        clipBottom
    };
}

function getClipInfoByCropDimensions({ clipRight, clipLeft, clipBottom, clipTop }, cropDimensions) {
    if (cropDimensions) {
        const right = cropDimensions.right,
              top = cropDimensions.top,
              bottom = cropDimensions.bottom,
              left = cropDimensions.left;


        clipRight = (0, _limitNumber2.default)(clipLeft + right, clipLeft, clipRight);
        clipBottom = (0, _limitNumber2.default)(clipTop + bottom, clipTop, clipBottom);
        clipLeft = (0, _limitNumber2.default)(clipLeft + left, clipLeft, clipRight);
        clipTop = (0, _limitNumber2.default)(clipTop + top, clipTop, clipBottom);
    }

    return {
        clipLeft,
        clipTop,
        clipRight,
        clipBottom
    };
}

function calculateClipInfo(pngImage, path, markSeed, clientAreaDimensions, cropDimensions) {
    let clipInfo = {
        clipRight: pngImage.width,
        clipBottom: pngImage.height,
        clipLeft: 0,
        clipTop: 0
    };

    let markPosition = null;

    if (markSeed && clientAreaDimensions) {
        markPosition = calculateMarkPosition(pngImage, markSeed);

        if (!markPosition) throw new Error((0, _renderTemplate2.default)(_warningMessage2.default.screenshotMarkNotFound, path, markSeedToId(markSeed)));

        clipInfo = getClipInfoByMarkPosition(markPosition, clientAreaDimensions);
    }

    clipInfo = getClipInfoByCropDimensions(clipInfo, cropDimensions);

    if (markPosition && markPosition.y === clipInfo.clipBottom) clipInfo.clipBottom--;

    const clipWidth = clipInfo.clipRight - clipInfo.clipLeft;
    const clipHeight = clipInfo.clipBottom - clipInfo.clipTop;

    if (clipWidth <= 0 || clipHeight <= 0) throw new _testRun.InvalidElementScreenshotDimensionsError(clipWidth, clipHeight);

    return clipInfo;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JlZW5zaG90cy9jcm9wLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJtYXJrU2VlZCIsImNsaWVudEFyZWFEaW1lbnNpb25zIiwiY3JvcERpbWVuc2lvbnMiLCJiaW5hcnlJbWFnZSIsInBuZ0ltYWdlIiwiY2xpcCIsImNhbGN1bGF0ZUNsaXBJbmZvIiwiY3JvcFNjcmVlbnNob3QiLCJjYWxjdWxhdGVNYXJrUG9zaXRpb24iLCJnZXRDbGlwSW5mb0J5TWFya1Bvc2l0aW9uIiwiZ2V0Q2xpcEluZm9CeUNyb3BEaW1lbnNpb25zIiwibWFya1NlZWRUb0lkIiwiaWQiLCJpIiwiTUFSS19MRU5HVEgiLCJNQVJLX0JZVEVTX1BFUl9QSVhFTCIsIm1hcmsiLCJCdWZmZXIiLCJmcm9tIiwibWFya0luZGV4IiwiZGF0YSIsImluZGV4T2YiLCJlbmRQb3NpdGlvbiIsIk1BUktfUklHSFRfTUFSR0lOIiwieCIsIndpZHRoIiwieSIsIm1hcmtQb3NpdGlvbiIsImhlaWdodCIsImNsaXBSaWdodCIsImNsaXBCb3R0b20iLCJjbGlwTGVmdCIsImNsaXBUb3AiLCJyaWdodCIsInRvcCIsImJvdHRvbSIsImxlZnQiLCJjbGlwSW5mbyIsIkVycm9yIiwiV0FSTklOR19NRVNTQUdFUyIsInNjcmVlbnNob3RNYXJrTm90Rm91bmQiLCJjbGlwV2lkdGgiLCJjbGlwSGVpZ2h0IiwiSW52YWxpZEVsZW1lbnRTY3JlZW5zaG90RGltZW5zaW9uc0Vycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OytDQW1HTyxXQUErQkEsSUFBL0IsRUFBcUNDLFFBQXJDLEVBQStDQyxvQkFBL0MsRUFBcUVDLGNBQXJFLEVBQXFGQyxXQUFyRixFQUFrRztBQUNyRyxZQUFJLENBQUNILFFBQUQsSUFBYSxDQUFDRSxjQUFsQixFQUNJLE9BQU8sSUFBUDs7QUFFSixjQUFNRSxXQUFXLE1BQU0sb0JBQVFELFdBQVIsQ0FBdkI7QUFDQSxjQUFNRSxPQUFXQyxrQkFBa0JGLFFBQWxCLEVBQTRC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eUltYWdlUGFydCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IGxpbWl0TnVtYmVyIGZyb20gJy4uL3V0aWxzL2xpbWl0LW51bWJlcic7XG5pbXBvcnQgcmVuZGVyVGVtcGxhdGUgZnJvbSAnLi4vdXRpbHMvcmVuZGVyLXRlbXBsYXRlJztcbmltcG9ydCB7IEludmFsaWRFbGVtZW50U2NyZWVuc2hvdERpbWVuc2lvbnNFcnJvciB9IGZyb20gJy4uL2Vycm9ycy90ZXN0LXJ1bi8nO1xuaW1wb3J0IHsgTUFSS19MRU5HVEgsIE1BUktfUklHSFRfTUFSR0lOLCBNQVJLX0JZVEVTX1BFUl9QSVhFTCB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCBXQVJOSU5HX01FU1NBR0VTIGZyb20gJy4uL25vdGlmaWNhdGlvbnMvd2FybmluZy1tZXNzYWdlJztcblxuXG5mdW5jdGlvbiBtYXJrU2VlZFRvSWQgKG1hcmtTZWVkKSB7XG4gICAgbGV0IGlkID0gMDtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTUFSS19MRU5HVEg7IGkrKylcbiAgICAgICAgaWQgPSBpZCAqIDIgKyAobWFya1NlZWRbaSAqIE1BUktfQllURVNfUEVSX1BJWEVMXSA/IDEgOiAwKTtcblxuICAgIHJldHVybiBpZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZU1hcmtQb3NpdGlvbiAocG5nSW1hZ2UsIG1hcmtTZWVkKSB7XG4gICAgY29uc3QgbWFyayAgICAgID0gQnVmZmVyLmZyb20obWFya1NlZWQpO1xuICAgIGNvbnN0IG1hcmtJbmRleCA9IHBuZ0ltYWdlLmRhdGEuaW5kZXhPZihtYXJrKTtcblxuICAgIGlmIChtYXJrSW5kZXggPCAwKVxuICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgIGNvbnN0IGVuZFBvc2l0aW9uID0gbWFya0luZGV4IC8gTUFSS19CWVRFU19QRVJfUElYRUwgKyBNQVJLX0xFTkdUSCArIE1BUktfUklHSFRfTUFSR0lOO1xuXG4gICAgY29uc3QgeCA9IGVuZFBvc2l0aW9uICUgcG5nSW1hZ2Uud2lkdGggfHwgcG5nSW1hZ2Uud2lkdGg7XG4gICAgY29uc3QgeSA9IChlbmRQb3NpdGlvbiAtIHgpIC8gcG5nSW1hZ2Uud2lkdGggKyAxO1xuXG4gICAgcmV0dXJuIHsgeCwgeSB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2xpcEluZm9CeU1hcmtQb3NpdGlvbiAobWFya1Bvc2l0aW9uLCB7IHdpZHRoLCBoZWlnaHQgfSkge1xuICAgIGNvbnN0IHsgeCwgeSB9ID0gbWFya1Bvc2l0aW9uO1xuXG4gICAgY29uc3QgY2xpcFJpZ2h0ICA9IHg7XG4gICAgY29uc3QgY2xpcEJvdHRvbSA9IHk7XG4gICAgY29uc3QgY2xpcExlZnQgICA9IGNsaXBSaWdodCAtIHdpZHRoO1xuICAgIGNvbnN0IGNsaXBUb3AgICAgPSBjbGlwQm90dG9tIC0gaGVpZ2h0O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgY2xpcExlZnQsXG4gICAgICAgIGNsaXBUb3AsXG4gICAgICAgIGNsaXBSaWdodCxcbiAgICAgICAgY2xpcEJvdHRvbVxuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDbGlwSW5mb0J5Q3JvcERpbWVuc2lvbnMgKHsgY2xpcFJpZ2h0LCBjbGlwTGVmdCwgY2xpcEJvdHRvbSwgY2xpcFRvcCB9LCBjcm9wRGltZW5zaW9ucykge1xuICAgIGlmIChjcm9wRGltZW5zaW9ucykge1xuICAgICAgICBjb25zdCB7IHJpZ2h0LCB0b3AsIGJvdHRvbSwgbGVmdCB9ID0gY3JvcERpbWVuc2lvbnM7XG5cbiAgICAgICAgY2xpcFJpZ2h0ICA9IGxpbWl0TnVtYmVyKGNsaXBMZWZ0ICsgcmlnaHQsIGNsaXBMZWZ0LCBjbGlwUmlnaHQpO1xuICAgICAgICBjbGlwQm90dG9tID0gbGltaXROdW1iZXIoY2xpcFRvcCArIGJvdHRvbSwgY2xpcFRvcCwgY2xpcEJvdHRvbSk7XG4gICAgICAgIGNsaXBMZWZ0ICAgPSBsaW1pdE51bWJlcihjbGlwTGVmdCArIGxlZnQsIGNsaXBMZWZ0LCBjbGlwUmlnaHQpO1xuICAgICAgICBjbGlwVG9wICAgID0gbGltaXROdW1iZXIoY2xpcFRvcCArIHRvcCwgY2xpcFRvcCwgY2xpcEJvdHRvbSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgY2xpcExlZnQsXG4gICAgICAgIGNsaXBUb3AsXG4gICAgICAgIGNsaXBSaWdodCxcbiAgICAgICAgY2xpcEJvdHRvbVxuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVDbGlwSW5mbyAocG5nSW1hZ2UsIHBhdGgsIG1hcmtTZWVkLCBjbGllbnRBcmVhRGltZW5zaW9ucywgY3JvcERpbWVuc2lvbnMpIHtcbiAgICBsZXQgY2xpcEluZm8gPSB7XG4gICAgICAgIGNsaXBSaWdodDogIHBuZ0ltYWdlLndpZHRoLFxuICAgICAgICBjbGlwQm90dG9tOiBwbmdJbWFnZS5oZWlnaHQsXG4gICAgICAgIGNsaXBMZWZ0OiAgIDAsXG4gICAgICAgIGNsaXBUb3A6ICAgIDBcbiAgICB9O1xuXG4gICAgbGV0IG1hcmtQb3NpdGlvbiA9IG51bGw7XG5cbiAgICBpZiAobWFya1NlZWQgJiYgY2xpZW50QXJlYURpbWVuc2lvbnMpIHtcbiAgICAgICAgbWFya1Bvc2l0aW9uID0gY2FsY3VsYXRlTWFya1Bvc2l0aW9uKHBuZ0ltYWdlLCBtYXJrU2VlZCk7XG5cbiAgICAgICAgaWYgKCFtYXJrUG9zaXRpb24pXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVuZGVyVGVtcGxhdGUoV0FSTklOR19NRVNTQUdFUy5zY3JlZW5zaG90TWFya05vdEZvdW5kLCBwYXRoLCBtYXJrU2VlZFRvSWQobWFya1NlZWQpKSk7XG5cbiAgICAgICAgY2xpcEluZm8gPSBnZXRDbGlwSW5mb0J5TWFya1Bvc2l0aW9uKG1hcmtQb3NpdGlvbiwgY2xpZW50QXJlYURpbWVuc2lvbnMpO1xuICAgIH1cblxuICAgIGNsaXBJbmZvID0gZ2V0Q2xpcEluZm9CeUNyb3BEaW1lbnNpb25zKGNsaXBJbmZvLCBjcm9wRGltZW5zaW9ucyk7XG5cbiAgICBpZiAobWFya1Bvc2l0aW9uICYmIG1hcmtQb3NpdGlvbi55ID09PSBjbGlwSW5mby5jbGlwQm90dG9tKVxuICAgICAgICBjbGlwSW5mby5jbGlwQm90dG9tLS07XG5cbiAgICBjb25zdCBjbGlwV2lkdGggID0gY2xpcEluZm8uY2xpcFJpZ2h0IC0gY2xpcEluZm8uY2xpcExlZnQ7XG4gICAgY29uc3QgY2xpcEhlaWdodCA9IGNsaXBJbmZvLmNsaXBCb3R0b20gLSBjbGlwSW5mby5jbGlwVG9wO1xuXG4gICAgaWYgKGNsaXBXaWR0aCA8PSAwIHx8IGNsaXBIZWlnaHQgPD0gMClcbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRFbGVtZW50U2NyZWVuc2hvdERpbWVuc2lvbnNFcnJvcihjbGlwV2lkdGgsIGNsaXBIZWlnaHQpO1xuXG4gICAgcmV0dXJuIGNsaXBJbmZvO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JvcFNjcmVlbnNob3QgKHBhdGgsIG1hcmtTZWVkLCBjbGllbnRBcmVhRGltZW5zaW9ucywgY3JvcERpbWVuc2lvbnMsIGJpbmFyeUltYWdlKSB7XG4gICAgaWYgKCFtYXJrU2VlZCAmJiAhY3JvcERpbWVuc2lvbnMpXG4gICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgY29uc3QgcG5nSW1hZ2UgPSBhd2FpdCByZWFkUG5nKGJpbmFyeUltYWdlKTtcbiAgICBjb25zdCBjbGlwICAgICA9IGNhbGN1bGF0ZUNsaXBJbmZvKHBuZ0ltYWdlLCBwYXRoLCBtYXJrU2VlZCwgY2xpZW50QXJlYURpbWVuc2lvbnMsIGNyb3BEaW1lbnNpb25zKTtcblxuICAgIHJldHVybiBjb3B5SW1hZ2VQYXJ0KHBuZ0ltYWdlLCBjbGlwKTtcbn1cbiJdfQ==
