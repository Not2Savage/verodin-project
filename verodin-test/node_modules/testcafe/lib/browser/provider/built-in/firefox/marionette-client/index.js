'use strict';

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _net = require('net');

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _promisifiedFunctions = require('../../../../../utils/promisified-functions');

var _delay = require('../../../../../utils/delay');

var _delay2 = _interopRequireDefault(_delay);

var _clientFunctions = require('../../../utils/client-functions');

var _commands = require('./commands');

var _commands2 = _interopRequireDefault(_commands);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const CONNECTION_TIMEOUT = 30000;
const CONNECTION_RETRY_DELAY = 300;
const MAX_RESIZE_RETRY_COUNT = 2;
const HEADER_SEPARATOR = ':';

module.exports = class MarionetteClient {
    constructor(port = 2828, host = '127.0.0.1') {
        this.currentPacketNumber = 1;
        this.events = new _events2.default();
        this.port = port;
        this.host = host;
        this.socket = new _net.Socket();
        this.buffer = Buffer.alloc(0);
        this.getPacketPromise = _pinkie2.default.resolve();
        this.sendPacketPromise = _pinkie2.default.resolve();

        this.protocolInfo = {
            applicationType: '',
            marionetteProtocol: ''
        };

        this.sessionInfo = null;
    }

    _attemptToConnect(port, host) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this.socket.connect(port, host);

            const connectionPromise = _pinkie2.default.race([(0, _promisifyEvent2.default)(_this.socket, 'connect'), (0, _promisifyEvent2.default)(_this.socket, 'error')]);

            return yield connectionPromise.then(function () {
                return true;
            }).catch(function () {
                _this.socket.removeAllListeners('connect');
                return (0, _delay2.default)(CONNECTION_RETRY_DELAY);
            });
        })();
    }

    _connectSocket(port, host) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const connectionStartTime = Date.now();

            let connected = yield _this2._attemptToConnect(port, host);

            while (!connected && Date.now() - connectionStartTime < CONNECTION_TIMEOUT) connected = yield _this2._attemptToConnect(port, host);

            if (!connected) throw new Error('Unable to connect');

            _this2.socket.on('data', function (data) {
                return _this2._handleNewData(data);
            });
        })();
    }

    _writeSocket(message) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this3.socket.write(message)) yield (0, _promisifyEvent2.default)(_this3.socket, 'drain');
        })();
    }

    _handleNewData(data) {
        if (!data) return;

        this.buffer = Buffer.concat([this.buffer, data]);

        this.events.emit('new-data');
    }

    _getPacket() {
        var _this4 = this;

        this.getPacketPromise = this.getPacketPromise.then((0, _asyncToGenerator3.default)(function* () {
            let headerEndIndex = _this4.buffer.indexOf(HEADER_SEPARATOR);

            while (headerEndIndex < 0) {
                yield (0, _promisifyEvent2.default)(_this4.events, 'new-data');

                headerEndIndex = _this4.buffer.indexOf(HEADER_SEPARATOR);
            }

            const packet = {
                length: NaN,
                body: null
            };

            packet.length = parseInt(_this4.buffer.toString('utf8', 0, headerEndIndex), 10) || 0;

            const bodyStartIndex = headerEndIndex + HEADER_SEPARATOR.length;
            const bodyEndIndex = bodyStartIndex + packet.length;

            if (packet.length) {
                while (_this4.buffer.length < bodyEndIndex) yield (0, _promisifyEvent2.default)(_this4.events, 'new-data');

                packet.body = JSON.parse(_this4.buffer.toString('utf8', bodyStartIndex, bodyEndIndex));
            }

            _this4.buffer = _this4.buffer.slice(bodyEndIndex);

            return packet;
        }));

        return this.getPacketPromise;
    }

    _sendPacket(payload) {
        var _this5 = this;

        this.sendPacketPromise = this.sendPacketPromise.then((0, _asyncToGenerator3.default)(function* () {
            const body = [0, _this5.currentPacketNumber++, payload.command, payload.parameters];
            const serialized = (0, _stringify2.default)(body);
            const message = Buffer.byteLength(serialized, 'utf8') + HEADER_SEPARATOR + serialized;

            _this5._writeSocket(message);
        }));

        return this.sendPacketPromise;
    }

    _throwMarionetteError(error) {
        throw new Error(`${error.error}${error.message ? ': ' + error.message : ''}`);
    }

    _getResponse(packet) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const packetNumber = _this6.currentPacketNumber;

            yield _this6._sendPacket(packet);

            let responsePacket = yield _this6._getPacket();

            while (!responsePacket.body || responsePacket.body[1] !== packetNumber) responsePacket = yield _this6._getPacket();

            if (responsePacket.body[2]) _this6._throwMarionetteError(responsePacket.body[2]);

            return responsePacket.body[3];
        })();
    }

    _getScreenshotData() {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this7._getResponse({ command: _commands2.default.takeScreenshot });
        })();
    }

    connect() {
        var _this8 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this8._connectSocket(_this8.port, _this8.host);

            const infoPacket = yield _this8._getPacket();

            _this8.protocolInfo = {
                applicationType: infoPacket.body.applicationType,
                marionetteProtocol: infoPacket.body.marionetteProtocol
            };

            _this8.sessionInfo = yield _this8._getResponse({ command: _commands2.default.newSession });
        })();
    }

    dispose() {
        this.socket.end();
        this.buffer = null;
    }

    executeScript(code) {
        var _this9 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this9._getResponse({
                command: _commands2.default.executeScript,
                parameters: { script: `return (${code})()` }
            });
        })();
    }

    takeScreenshot(path) {
        var _this10 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const screenshotData = yield _this10._getScreenshotData();

            yield (0, _promisifiedFunctions.writeFile)(path, screenshotData.value, { encoding: 'base64' });
        })();
    }

    getVideoFrameData() {
        var _this11 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const frameData = yield _this11._getScreenshotData();

            return Buffer.from(frameData.value, 'base64');
        })();
    }

    setWindowSize(width, height) {
        var _this12 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var _ref3 = yield _this12.executeScript(_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            let pageRect = _ref3.value;

            let attemptCounter = 0;

            while (attemptCounter++ < MAX_RESIZE_RETRY_COUNT && (pageRect.width !== width || pageRect.height !== height)) {
                const currentRect = yield _this12._getResponse({ command: _commands2.default.getWindowRect });

                yield _this12._getResponse({
                    command: _commands2.default.setWindowRect,

                    parameters: {
                        x: currentRect.x,
                        y: currentRect.y,
                        width: width + (currentRect.width - pageRect.width),
                        height: height + (currentRect.height - pageRect.height)
                    }
                });

                var _ref4 = yield _this12.executeScript(_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

                pageRect = _ref4.value;
            }
        })();
    }

    quit() {
        var _this13 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this13._getResponse({ command: _commands2.default.quit });
        })();
    }
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2ZpcmVmb3gvbWFyaW9uZXR0ZS1jbGllbnQvaW5kZXguanMiXSwibmFtZXMiOlsiQ09OTkVDVElPTl9USU1FT1VUIiwiQ09OTkVDVElPTl9SRVRSWV9ERUxBWSIsIk1BWF9SRVNJWkVfUkVUUllfQ09VTlQiLCJIRUFERVJfU0VQQVJBVE9SIiwibW9kdWxlIiwiZXhwb3J0cyIsIk1hcmlvbmV0dGVDbGllbnQiLCJjb25zdHJ1Y3RvciIsInBvcnQiLCJob3N0IiwiY3VycmVudFBhY2tldE51bWJlciIsImV2ZW50cyIsIkV2ZW50RW1pdHRlciIsInNvY2tldCIsIlNvY2tldCIsImJ1ZmZlciIsIkJ1ZmZlciIsImFsbG9jIiwiZ2V0UGFja2V0UHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwic2VuZFBhY2tldFByb21pc2UiLCJwcm90b2NvbEluZm8iLCJhcHBsaWNhdGlvblR5cGUiLCJtYXJpb25ldHRlUHJvdG9jb2wiLCJzZXNzaW9uSW5mbyIsIl9hdHRlbXB0VG9Db25uZWN0IiwiY29ubmVjdCIsImNvbm5lY3Rpb25Qcm9taXNlIiwicmFjZSIsInRoZW4iLCJjYXRjaCIsInJlbW92ZUFsbExpc3RlbmVycyIsIl9jb25uZWN0U29ja2V0IiwiY29ubmVjdGlvblN0YXJ0VGltZSIsIkRhdGUiLCJub3ciLCJjb25uZWN0ZWQiLCJFcnJvciIsIm9uIiwiX2hhbmRsZU5ld0RhdGEiLCJkYXRhIiwiX3dyaXRlU29ja2V0IiwibWVzc2FnZSIsIndyaXRlIiwiY29uY2F0IiwiZW1pdCIsIl9nZXRQYWNrZXQiLCJoZWFkZXJFbmRJbmRleCIsImluZGV4T2YiLCJwYWNrZXQiLCJsZW5ndGgiLCJOYU4iLCJib2R5IiwicGFyc2VJbnQiLCJ0b1N0cmluZyIsImJvZHlTdGFydEluZGV4IiwiYm9keUVuZEluZGV4IiwiSlNPTiIsInBhcnNlIiwic2xpY2UiLCJfc2VuZFBhY2tldCIsInBheWxvYWQiLCJjb21tYW5kIiwicGFyYW1ldGVycyIsInNlcmlhbGl6ZWQiLCJieXRlTGVuZ3RoIiwiX3Rocm93TWFyaW9uZXR0ZUVycm9yIiwiZXJyb3IiLCJfZ2V0UmVzcG9uc2UiLCJwYWNrZXROdW1iZXIiLCJyZXNwb25zZVBhY2tldCIsIl9nZXRTY3JlZW5zaG90RGF0YSIsIkNPTU1BTkRTIiwidGFrZVNjcmVlbnNob3QiLCJpbmZvUGFja2V0IiwibmV3U2Vzc2lvbiIsImRpc3Bvc2UiLCJlbmQiLCJleGVjdXRlU2NyaXB0IiwiY29kZSIsInNjcmlwdCIsInBhdGgiLCJzY3JlZW5zaG90RGF0YSIsInZhbHVlIiwiZW5jb2RpbmciLCJnZXRWaWRlb0ZyYW1lRGF0YSIsImZyYW1lRGF0YSIsImZyb20iLCJzZXRXaW5kb3dTaXplIiwid2lkdGgiLCJoZWlnaHQiLCJHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQiLCJwYWdlUmVjdCIsImF0dGVtcHRDb3VudGVyIiwiY3VycmVudFJlY3QiLCJnZXRXaW5kb3dSZWN0Iiwic2V0V2luZG93UmVjdCIsIngiLCJ5IiwicXVpdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7OztBQUdBLE1BQU1BLHFCQUF5QixLQUEvQjtBQUNBLE1BQU1DLHlCQUF5QixHQUEvQjtBQUNBLE1BQU1DLHlCQUF5QixDQUEvQjtBQUNBLE1BQU1DLG1CQUF5QixHQUEvQjs7QUFFQUMsT0FBT0MsT0FBUCxHQUFpQixNQUFNQyxnQkFBTixDQUF1QjtBQUNwQ0MsZ0JBQWFDLE9BQU8sSUFBcEIsRUFBMEJDLE9BQU8sV0FBakMsRUFBOEM7QUFDMUMsYUFBS0MsbUJBQUwsR0FBMkIsQ0FBM0I7QUFDQSxhQUFLQyxNQUFMLEdBQTJCLElBQUlDLGdCQUFKLEVBQTNCO0FBQ0EsYUFBS0osSUFBTCxHQUEyQkEsSUFBM0I7QUFDQSxhQUFLQyxJQUFMLEdBQTJCQSxJQUEzQjtBQUNB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QUtaLGFBQUwsQ0FBbUJhLGtEQUFuQixDQURBOztBQUFBLGdCQUNuQkMsUUFEbUIsU0FDMUJULEtBRDBCOztBQUVoQyxnQkFBSVUsaUJBQXNCLENBQTFCOztBQUVBLG1CQUFPQSxtQkFBbUI1RixzQkFBbkIsS0FBOEMyRixTQUFTSCxLQUFULEtBQW1CQSxLQUFuQixJQUE0QkcsU0FBU0YsTUFBVCxLQUFvQkEsTUFBOUYsQ0FBUCxFQUE4RztBQUMxRyxzQkFBTUksY0FBYyxNQUFNLFFBQUsxQixZQUFMLENBQWtCLEVBQUVOLFNBQVNVLG1CQUFTdUIsYUFBcEIsRUFBbEIsQ0FBMUI7O0FBRUEsc0JBQU0sUUFBSzNCLFlBQUwsQ0FBa0I7QUFDcEJOLDZCQUFTVSxtQkFBU3dCLGFBREU7O0FBR3BCakMsZ0NBQVk7QUFDUmtDLDJCQUFRSCxZQUFZRyxDQURaO0FBRVJDLDJCQUFRSixZQUFZSSxDQUZaO0FBR1JULCtCQUFRQSxTQUFTSyxZQUFZTCxLQUFaLEdBQW9CRyxTQUFTSCxLQUF0QyxDQUhBO0FBSVJDLGdDQUFRQSxVQUFVSSxZQUFZSixNQUFaLEdBQXFCRSxTQUFTRixNQUF4QztBQUpBO0FBSFEsaUJBQWxCLENBQU47O0FBSDBHLDRCQWNuRixNQUFNLFFBQUtaLGFBQUwsQ0FBbUJhLGtEQUFuQixDQWQ2RTs7QUFjaEdDLHdCQWRnRyxTQWN2R1QsS0FkdUc7QUFlN0c7QUFuQitCO0FBb0JuQzs7QUFFS2dCLFFBQU4sR0FBYztBQUFBOztBQUFBO0FBQ1Ysa0JBQU0sUUFBSy9CLFlBQUwsQ0FBa0IsRUFBRU4sU0FBU1UsbUJBQVMyQixJQUFwQixFQUFsQixDQUFOO0FBRFU7QUFFYjtBQW5NbUMsQ0FBeEMiLCJmaWxlIjoiYnJvd3Nlci9wcm92aWRlci9idWlsdC1pbi9maXJlZm94L21hcmlvbmV0dGUtY2xpZW50L2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCB7IFNvY2tldCB9IGZyb20gJ25ldCc7XG5pbXBvcnQgcHJvbWlzaWZ5RXZlbnQgZnJvbSAncHJvbWlzaWZ5LWV2ZW50JztcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IHdyaXRlRmlsZSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL3V0aWxzL3Byb21pc2lmaWVkLWZ1bmN0aW9ucyc7XG5pbXBvcnQgZGVsYXkgZnJvbSAnLi4vLi4vLi4vLi4vLi4vdXRpbHMvZGVsYXknO1xuaW1wb3J0IHsgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvY2xpZW50LWZ1bmN0aW9ucyc7XG5pbXBvcnQgQ09NTUFORFMgZnJvbSAnLi9jb21tYW5kcyc7XG5cblxuY29uc3QgQ09OTkVDVElPTl9USU1FT1VUICAgICA9IDMwMDAwO1xuY29uc3QgQ09OTkVDVElPTl9SRVRSWV9ERUxBWSA9IDMwMDtcbmNvbnN0IE1BWF9SRVNJWkVfUkVUUllfQ09VTlQgPSAyO1xuY29uc3QgSEVBREVSX1NFUEFSQVRPUiAgICAgICA9ICc6JztcblxubW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBNYXJpb25ldHRlQ2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvciAocG9ydCA9IDI4MjgsIGhvc3QgPSAnMTI3LjAuMC4xJykge1xuICAgICAgICB0aGlzLmN1cnJlbnRQYWNrZXROdW1iZXIgPSAxO1xuICAgICAgICB0aGlzLmV2ZW50cyAgICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgICAgIHRoaXMucG9ydCAgICAgICAgICAgICAgICA9IHBvcnQ7XG4gICAgICAgIHRoaXMuaG9zdCAgICAgICAgICAgICAgICA9IGhvc3Q7XG4gICAgICAgIHRoaXMuc29ja2V0ICAgICAgICAgICAgICA9IG5ldyBTb2NrZXQoKTtcbiAgICAgICAgdGhpcy5idWZmZXIgICAgICAgICAgICAgID0gQnVmZmVyLmFsbG9jKDApO1xuICAgICAgICB0aGlzLmdldFBhY2tldFByb21pc2UgICAgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgdGhpcy5zZW5kUGFja2V0UHJvbWlzZSAgID0gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgdGhpcy5wcm90b2NvbEluZm8gPSB7XG4gICAgICAgICAgICBhcHBsaWNhdGlvblR5cGU6ICAgICcnLFxuICAgICAgICAgICAgbWFyaW9uZXR0ZVByb3RvY29sOiAnJyxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNlc3Npb25JbmZvID0gbnVsbDtcbiAgICB9XG5cbiAgICBhc3luYyBfYXR0ZW1wdFRvQ29ubmVjdCAocG9ydCwgaG9zdCkge1xuICAgICAgICB0aGlzLnNvY2tldC5jb25uZWN0KHBvcnQsIGhvc3QpO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25Qcm9taXNlID0gUHJvbWlzZS5yYWNlKFtcbiAgICAgICAgICAgIHByb21pc2lmeUV2ZW50KHRoaXMuc29ja2V0LCAnY29ubmVjdCcpLFxuICAgICAgICAgICAgcHJvbWlzaWZ5RXZlbnQodGhpcy5zb2NrZXQsICdlcnJvcicpXG4gICAgICAgIF0pO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCBjb25uZWN0aW9uUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdHJ1ZSlcbiAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKCdjb25uZWN0Jyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlbGF5KENPTk5FQ1RJT05fUkVUUllfREVMQVkpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2Nvbm5lY3RTb2NrZXQgKHBvcnQsIGhvc3QpIHtcbiAgICAgICAgY29uc3QgY29ubmVjdGlvblN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICAgICAgbGV0IGNvbm5lY3RlZCA9IGF3YWl0IHRoaXMuX2F0dGVtcHRUb0Nvbm5lY3QocG9ydCwgaG9zdCk7XG5cbiAgICAgICAgd2hpbGUgKCFjb25uZWN0ZWQgJiYgRGF0ZS5ub3coKSAtIGNvbm5lY3Rpb25TdGFydFRpbWUgPCBDT05ORUNUSU9OX1RJTUVPVVQpXG4gICAgICAgICAgICBjb25uZWN0ZWQgPSBhd2FpdCB0aGlzLl9hdHRlbXB0VG9Db25uZWN0KHBvcnQsIGhvc3QpO1xuXG4gICAgICAgIGlmICghY29ubmVjdGVkKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gY29ubmVjdCcpO1xuXG4gICAgICAgIHRoaXMuc29ja2V0Lm9uKCdkYXRhJywgZGF0YSA9PiB0aGlzLl9oYW5kbGVOZXdEYXRhKGRhdGEpKTtcbiAgICB9XG5cbiAgICBhc3luYyBfd3JpdGVTb2NrZXQgKG1lc3NhZ2UpIHtcbiAgICAgICAgaWYgKCF0aGlzLnNvY2tldC53cml0ZShtZXNzYWdlKSlcbiAgICAgICAgICAgIGF3YWl0IHByb21pc2lmeUV2ZW50KHRoaXMuc29ja2V0LCAnZHJhaW4nKTtcbiAgICB9XG5cbiAgICBfaGFuZGxlTmV3RGF0YSAoZGF0YSkge1xuICAgICAgICBpZiAoIWRhdGEpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5idWZmZXIgPSBCdWZmZXIuY29uY2F0KFt0aGlzLmJ1ZmZlciwgZGF0YV0pO1xuXG4gICAgICAgIHRoaXMuZXZlbnRzLmVtaXQoJ25ldy1kYXRhJyk7XG4gICAgfVxuXG4gICAgX2dldFBhY2tldCAoKSB7XG4gICAgICAgIHRoaXMuZ2V0UGFja2V0UHJvbWlzZSA9IHRoaXMuZ2V0UGFja2V0UHJvbWlzZS50aGVuKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGxldCBoZWFkZXJFbmRJbmRleCA9IHRoaXMuYnVmZmVyLmluZGV4T2YoSEVBREVSX1NFUEFSQVRPUik7XG5cbiAgICAgICAgICAgIHdoaWxlIChoZWFkZXJFbmRJbmRleCA8IDApIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBwcm9taXNpZnlFdmVudCh0aGlzLmV2ZW50cywgJ25ldy1kYXRhJyk7XG5cbiAgICAgICAgICAgICAgICBoZWFkZXJFbmRJbmRleCA9IHRoaXMuYnVmZmVyLmluZGV4T2YoSEVBREVSX1NFUEFSQVRPUik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHBhY2tldCA9IHtcbiAgICAgICAgICAgICAgICBsZW5ndGg6IE5hTixcbiAgICAgICAgICAgICAgICBib2R5OiAgIG51bGxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHBhY2tldC5sZW5ndGggPSBwYXJzZUludCh0aGlzLmJ1ZmZlci50b1N0cmluZygndXRmOCcsIDAsIGhlYWRlckVuZEluZGV4KSwgMTApIHx8IDA7XG5cbiAgICAgICAgICAgIGNvbnN0IGJvZHlTdGFydEluZGV4ID0gaGVhZGVyRW5kSW5kZXggKyBIRUFERVJfU0VQQVJBVE9SLmxlbmd0aDtcbiAgICAgICAgICAgIGNvbnN0IGJvZHlFbmRJbmRleCAgID0gYm9keVN0YXJ0SW5kZXggKyBwYWNrZXQubGVuZ3RoO1xuXG4gICAgICAgICAgICBpZiAocGFja2V0Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHdoaWxlICh0aGlzLmJ1ZmZlci5sZW5ndGggPCBib2R5RW5kSW5kZXgpXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHByb21pc2lmeUV2ZW50KHRoaXMuZXZlbnRzLCAnbmV3LWRhdGEnKTtcblxuICAgICAgICAgICAgICAgIHBhY2tldC5ib2R5ID0gSlNPTi5wYXJzZSh0aGlzLmJ1ZmZlci50b1N0cmluZygndXRmOCcsIGJvZHlTdGFydEluZGV4LCBib2R5RW5kSW5kZXgpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5idWZmZXIgPSB0aGlzLmJ1ZmZlci5zbGljZShib2R5RW5kSW5kZXgpO1xuXG4gICAgICAgICAgICByZXR1cm4gcGFja2V0O1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQYWNrZXRQcm9taXNlO1xuICAgIH1cblxuICAgIF9zZW5kUGFja2V0IChwYXlsb2FkKSB7XG4gICAgICAgIHRoaXMuc2VuZFBhY2tldFByb21pc2UgPSB0aGlzLnNlbmRQYWNrZXRQcm9taXNlLnRoZW4oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgYm9keSAgICAgICA9IFswLCB0aGlzLmN1cnJlbnRQYWNrZXROdW1iZXIrKywgcGF5bG9hZC5jb21tYW5kLCBwYXlsb2FkLnBhcmFtZXRlcnNdO1xuICAgICAgICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IEpTT04uc3RyaW5naWZ5KGJvZHkpO1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSAgICA9IEJ1ZmZlci5ieXRlTGVuZ3RoKHNlcmlhbGl6ZWQsICd1dGY4JykgKyBIRUFERVJfU0VQQVJBVE9SICsgc2VyaWFsaXplZDtcblxuICAgICAgICAgICAgdGhpcy5fd3JpdGVTb2NrZXQobWVzc2FnZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnNlbmRQYWNrZXRQcm9taXNlO1xuICAgIH1cblxuICAgIF90aHJvd01hcmlvbmV0dGVFcnJvciAoZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2Vycm9yLmVycm9yfSR7ZXJyb3IubWVzc2FnZSA/ICc6ICcgKyBlcnJvci5tZXNzYWdlIDogJyd9YCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2dldFJlc3BvbnNlIChwYWNrZXQpIHtcbiAgICAgICAgY29uc3QgcGFja2V0TnVtYmVyID0gdGhpcy5jdXJyZW50UGFja2V0TnVtYmVyO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuX3NlbmRQYWNrZXQocGFja2V0KTtcblxuICAgICAgICBsZXQgcmVzcG9uc2VQYWNrZXQgPSBhd2FpdCB0aGlzLl9nZXRQYWNrZXQoKTtcblxuICAgICAgICB3aGlsZSAoIXJlc3BvbnNlUGFja2V0LmJvZHkgfHwgcmVzcG9uc2VQYWNrZXQuYm9keVsxXSAhPT0gcGFja2V0TnVtYmVyKVxuICAgICAgICAgICAgcmVzcG9uc2VQYWNrZXQgPSBhd2FpdCB0aGlzLl9nZXRQYWNrZXQoKTtcblxuICAgICAgICBpZiAocmVzcG9uc2VQYWNrZXQuYm9keVsyXSlcbiAgICAgICAgICAgIHRoaXMuX3Rocm93TWFyaW9uZXR0ZUVycm9yKHJlc3BvbnNlUGFja2V0LmJvZHlbMl0pO1xuXG4gICAgICAgIHJldHVybiByZXNwb25zZVBhY2tldC5ib2R5WzNdO1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRTY3JlZW5zaG90RGF0YSAoKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9nZXRSZXNwb25zZSh7IGNvbW1hbmQ6IENPTU1BTkRTLnRha2VTY3JlZW5zaG90IH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGNvbm5lY3QgKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9jb25uZWN0U29ja2V0KHRoaXMucG9ydCwgdGhpcy5ob3N0KTtcblxuICAgICAgICBjb25zdCBpbmZvUGFja2V0ID0gYXdhaXQgdGhpcy5fZ2V0UGFja2V0KCk7XG5cbiAgICAgICAgdGhpcy5wcm90b2NvbEluZm8gPSB7XG4gICAgICAgICAgICBhcHBsaWNhdGlvblR5cGU6ICAgIGluZm9QYWNrZXQuYm9keS5hcHBsaWNhdGlvblR5cGUsXG4gICAgICAgICAgICBtYXJpb25ldHRlUHJvdG9jb2w6IGluZm9QYWNrZXQuYm9keS5tYXJpb25ldHRlUHJvdG9jb2xcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNlc3Npb25JbmZvID0gYXdhaXQgdGhpcy5fZ2V0UmVzcG9uc2UoeyBjb21tYW5kOiBDT01NQU5EUy5uZXdTZXNzaW9uIH0pO1xuICAgIH1cblxuICAgIGRpc3Bvc2UgKCkge1xuICAgICAgICB0aGlzLnNvY2tldC5lbmQoKTtcbiAgICAgICAgdGhpcy5idWZmZXIgPSBudWxsO1xuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGVTY3JpcHQgKGNvZGUpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2dldFJlc3BvbnNlKHtcbiAgICAgICAgICAgIGNvbW1hbmQ6ICAgIENPTU1BTkRTLmV4ZWN1dGVTY3JpcHQsXG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7IHNjcmlwdDogYHJldHVybiAoJHtjb2RlfSkoKWAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyB0YWtlU2NyZWVuc2hvdCAocGF0aCkge1xuICAgICAgICBjb25zdCBzY3JlZW5zaG90RGF0YSA9IGF3YWl0IHRoaXMuX2dldFNjcmVlbnNob3REYXRhKCk7XG5cbiAgICAgICAgYXdhaXQgd3JpdGVGaWxlKHBhdGgsIHNjcmVlbnNob3REYXRhLnZhbHVlLCB7IGVuY29kaW5nOiAnYmFzZTY0JyB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRWaWRlb0ZyYW1lRGF0YSAoKSB7XG4gICAgICAgIGNvbnN0IGZyYW1lRGF0YSA9IGF3YWl0IHRoaXMuX2dldFNjcmVlbnNob3REYXRhKCk7XG5cbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGZyYW1lRGF0YS52YWx1ZSwgJ2Jhc2U2NCcpO1xuICAgIH1cblxuICAgIGFzeW5jIHNldFdpbmRvd1NpemUgKHdpZHRoLCBoZWlnaHQpIHtcbiAgICAgICAgbGV0IHsgdmFsdWU6IHBhZ2VSZWN0IH0gPSBhd2FpdCB0aGlzLmV4ZWN1dGVTY3JpcHQoR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUKTtcbiAgICAgICAgbGV0IGF0dGVtcHRDb3VudGVyICAgICAgPSAwO1xuXG4gICAgICAgIHdoaWxlIChhdHRlbXB0Q291bnRlcisrIDwgTUFYX1JFU0laRV9SRVRSWV9DT1VOVCAmJiAocGFnZVJlY3Qud2lkdGggIT09IHdpZHRoIHx8IHBhZ2VSZWN0LmhlaWdodCAhPT0gaGVpZ2h0KSkge1xuICAgICAgICAgICAgY29uc3QgY3VycmVudFJlY3QgPSBhd2FpdCB0aGlzLl9nZXRSZXNwb25zZSh7IGNvbW1hbmQ6IENPTU1BTkRTLmdldFdpbmRvd1JlY3QgfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2dldFJlc3BvbnNlKHtcbiAgICAgICAgICAgICAgICBjb21tYW5kOiBDT01NQU5EUy5zZXRXaW5kb3dSZWN0LFxuXG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgICAgICAgICAgICB4OiAgICAgIGN1cnJlbnRSZWN0LngsXG4gICAgICAgICAgICAgICAgICAgIHk6ICAgICAgY3VycmVudFJlY3QueSxcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6ICB3aWR0aCArIChjdXJyZW50UmVjdC53aWR0aCAtIHBhZ2VSZWN0LndpZHRoKSxcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQgKyAoY3VycmVudFJlY3QuaGVpZ2h0IC0gcGFnZVJlY3QuaGVpZ2h0KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAoeyB2YWx1ZTogcGFnZVJlY3QgfSA9IGF3YWl0IHRoaXMuZXhlY3V0ZVNjcmlwdChHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHF1aXQgKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9nZXRSZXNwb25zZSh7IGNvbW1hbmQ6IENPTU1BTkRTLnF1aXQgfSk7XG4gICAgfVxufTtcblxuIl19
