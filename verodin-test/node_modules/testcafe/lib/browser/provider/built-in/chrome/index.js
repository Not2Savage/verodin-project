'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _osFamily = require('os-family');

var _osFamily2 = _interopRequireDefault(_osFamily);

var _url = require('url');

var _runtimeInfo = require('./runtime-info');

var _runtimeInfo2 = _interopRequireDefault(_runtimeInfo);

var _localChrome = require('./local-chrome');

var _cdp = require('./cdp');

var cdp = _interopRequireWildcard(_cdp);

var _getMaximizedHeadlessWindowSize = require('../../utils/get-maximized-headless-window-size');

var _getMaximizedHeadlessWindowSize2 = _interopRequireDefault(_getMaximizedHeadlessWindowSize);

var _clientFunctions = require('../../utils/client-functions');

var _crop = require('../../../../screenshots/crop');

var _utils = require('../../../../screenshots/utils');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const MIN_AVAILABLE_DIMENSION = 50;

exports.default = {
    openedBrowsers: {},

    isMultiBrowser: false,

    openBrowser(browserId, pageUrl, configString) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = yield (0, _runtimeInfo2.default)((0, _url.parse)(pageUrl).hostname, configString);
            const browserName = _this.providerName.replace(':', '');

            runtimeInfo.browserId = browserId;
            runtimeInfo.browserName = browserName;

            runtimeInfo.providerMethods = {
                resizeLocalBrowserWindow: function resizeLocalBrowserWindow(...args) {
                    return _this.resizeLocalBrowserWindow(...args);
                }
            };

            yield (0, _localChrome.start)(pageUrl, runtimeInfo);

            yield _this.waitForConnectionReady(browserId);

            runtimeInfo.viewportSize = yield _this.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            yield cdp.createClient(runtimeInfo);

            _this.openedBrowsers[browserId] = runtimeInfo;

            yield _this._ensureWindowIsExpanded(browserId, runtimeInfo.viewportSize);
        })();
    },

    closeBrowser(browserId) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = _this2.openedBrowsers[browserId];

            if (cdp.isHeadlessTab(runtimeInfo)) yield cdp.closeTab(runtimeInfo);else yield _this2.closeLocalBrowser(browserId);

            if (_osFamily2.default.mac || runtimeInfo.config.headless) yield (0, _localChrome.stop)(runtimeInfo);

            if (runtimeInfo.tempProfileDir) yield runtimeInfo.tempProfileDir.dispose();

            delete _this2.openedBrowsers[browserId];
        })();
    },

    isLocalBrowser() {
        return (0, _asyncToGenerator3.default)(function* () {
            return true;
        })();
    },

    isHeadlessBrowser(browserId) {
        return this.openedBrowsers[browserId].config.headless;
    },

    takeScreenshot(browserId, path) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = _this3.openedBrowsers[browserId];
            const viewport = yield cdp.getPageViewport(runtimeInfo);
            const binaryImage = yield cdp.getScreenshotData(runtimeInfo);

            const clientWidth = viewport.clientWidth,
                  clientHeight = viewport.clientHeight;


            const croppedImage = yield (0, _crop.cropScreenshot)(path, false, null, {
                right: clientWidth,
                left: 0,
                top: 0,
                bottom: clientHeight
            }, binaryImage);

            if (croppedImage) yield (0, _utils.writePng)(path, croppedImage);
        })();
    },

    resizeWindow(browserId, width, height, currentWidth, currentHeight) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = _this4.openedBrowsers[browserId];

            if (runtimeInfo.config.mobile) yield cdp.updateMobileViewportSize(runtimeInfo);else {
                runtimeInfo.viewportSize.width = currentWidth;
                runtimeInfo.viewportSize.height = currentHeight;
            }

            yield cdp.resizeWindow({ width, height }, runtimeInfo);
        })();
    },

    maximizeWindow(browserId) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const maximumSize = (0, _getMaximizedHeadlessWindowSize2.default)();

            yield _this5.resizeWindow(browserId, maximumSize.width, maximumSize.height, maximumSize.width, maximumSize.height);
        })();
    },

    getVideoFrameData(browserId) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield cdp.getScreenshotData(_this6.openedBrowsers[browserId]);
        })();
    },

    hasCustomActionForBrowser(browserId) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var _openedBrowsers$brows = _this7.openedBrowsers[browserId];
            const config = _openedBrowsers$brows.config,
                  client = _openedBrowsers$brows.client;


            return {
                hasCloseBrowser: true,
                hasResizeWindow: !!client && (config.emulation || config.headless),
                hasMaximizeWindow: !!client && config.headless,
                hasTakeScreenshot: !!client,
                hasChromelessScreenshots: !!client,
                hasGetVideoFrameData: !!client,
                hasCanResizeWindowToDimensions: false
            };
        })();
    },

    _ensureWindowIsExpanded(browserId, { height, width, availableHeight, availableWidth, outerWidth, outerHeight }) {
        var _this8 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (height < MIN_AVAILABLE_DIMENSION || width < MIN_AVAILABLE_DIMENSION) {
                const newHeight = availableHeight;
                const newWidth = Math.floor(availableWidth / 2);

                yield _this8.resizeWindow(browserId, newWidth, newHeight, outerWidth, outerHeight);
            }
        })();
    }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9pbmRleC5qcyJdLCJuYW1lcyI6WyJjZHAiLCJNSU5fQVZBSUxBQkxFX0RJTUVOU0lPTiIsIm9wZW5lZEJyb3dzZXJzIiwiaXNNdWx0aUJyb3dzZXIiLCJvcGVuQnJvd3NlciIsImJyb3dzZXJJZCIsInBhZ2VVcmwiLCJjb25maWdTdHJpbmciLCJydW50aW1lSW5mbyIsImhvc3RuYW1lIiwiYnJvd3Nlck5hbWUiLCJwcm92aWRlck5hbWUiLCJyZXBsYWNlIiwicHJvdmlkZXJNZXRob2RzIiwicmVzaXplTG9jYWxCcm93c2VyV2luZG93IiwiYXJncyIsIndhaXRGb3JDb25uZWN0aW9uUmVhZHkiLCJ2aWV3cG9ydFNpemUiLCJydW5Jbml0U2NyaXB0IiwiR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIiwiY3JlYXRlQ2xpZW50IiwiX2Vuc3VyZVdpbmRvd0lzRXhwYW5kZWQiLCJjbG9zZUJyb3dzZXIiLCJpc0hlYWRsZXNzVGFiIiwiY2xvc2VUYWIiLCJjbG9zZUxvY2FsQnJvd3NlciIsIk9TIiwibWFjIiwiY29uZmlnIiwiaGVhZGxlc3MiLCJ0ZW1wUHJvZmlsZURpciIsImRpc3Bvc2UiLCJpc0xvY2FsQnJvd3NlciIsImlzSGVhZGxlc3NCcm93c2VyIiwidGFrZVNjcmVlbnNob3QiLCJwYXRoIiwidmlld3BvcnQiLCJnZXRQYWdlVmlld3BvcnQiLCJiaW5hcnlJbWFnZSIsImdldFNjcmVlbnNob3REYXRhIiwiY2xpZW50V2lkdGgiLCJjbGllbnRIZWlnaHQiLCJjcm9wcGVkSW1hZ2UiLCJyaWdodCIsImxlZnQiLCJ0b3AiLCJib3R0b20iLCJyZXNpemVXaW5kb3ciLCJ3aWR0aCIsImhlaWdodCIsImN1cnJlbnRXaWR0aCIsImN1cnJlbnRIZWlnaHQiLCJtb2JpbGUiLCJ1cGRhdGVNb2JpbGVWaWV3cG9ydFNpemUiLCJtYXhpbWl6ZVdpbmRvdyIsIm1heGltdW1TaXplIiwiZ2V0VmlkZW9GcmFtZURhdGEiLCJoYXNDdXN0b21BY3Rpb25Gb3JCcm93c2VyIiwiY2xpZW50IiwiaGFzQ2xvc2VCcm93c2VyIiwiaGFzUmVzaXplV2luZG93IiwiZW11bGF0aW9uIiwiaGFzTWF4aW1pemVXaW5kb3ciLCJoYXNUYWtlU2NyZWVuc2hvdCIsImhhc0Nocm9tZWxlc3NTY3JlZW5zaG90cyIsImhhc0dldFZpZGVvRnJhbWVEYXRhIiwiaGFzQ2FuUmVzaXplV2luZG93VG9EaW1lbnNpb25zIiwiYXZhaWxhYmxlSGVpZ2h0IiwiYXZhaWxhYmxlV2lkdGgiLCJvdXRlcldpZHRoIiwib3V0ZXJIZWlnaHQiLCJuZXdIZWlnaHQiLCJuZXdXaWR0aCIsIk1hdGgiLCJmbG9vciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0lBQVlBLEc7O0FBQ1o7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRUEsTUFBTUMsMEJBQTBCLEVBQWhDOztrQkFFZTtBQUNYQyxvQkFBZ0IsRUFETDs7QUFHWEMsb0JBQWdCLEtBSEw7O0FBS0xDLGVBQU4sQ0FBbUJDLFNBQW5CLEVBQThCQyxPQUE5QixFQUF1Q0MsWUFBdkMsRUFBcUQ7QUFBQTs7QUFBQTtBQUNqRCxrQkFBTUMsY0FBYyxNQUFNLDJCQUFlLGdCQUFTRixPQUFULEVBQWtCRyxRQUFqQyxFQUEyQ0YsWUFBM0MsQ0FBMUI7QUFDQSxrQkFBTUcsY0FBYyxNQUFLQyxZQUFMLENBQWtCQyxPQUFsQixDQUEwQixHQUExQixFQUErQixFQUEvQixDQUFwQjs7QUFFQUosd0JBQVlILFNBQVosR0FBMEJBLFNBQTFCO0FBQ0FHLHdCQUFZRSxXQUFaLEdBQTBCQSxXQUExQjs7QUFFQUYsd0JBQVlLLGVBQVosR0FBOEI7QUFDMUJDLDBDQUEwQixrQ0FBQyxHQUFHQyxJQUFKO0FBQUEsMkJBQWEsTUFBS0Qsd0JBQUwsQ0FBOEIsR0FBR0MsSUFBakMsQ0FBYjtBQUFBO0FBREEsYUFBOUI7O0FBSUEs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O0FBNkdMN0MsMkJBQU4sQ0FBK0JoQixTQUEvQixFQUEwQyxFQUFFNEMsTUFBRixFQUFVRCxLQUFWLEVBQWlCbUIsZUFBakIsRUFBa0NDLGNBQWxDLEVBQWtEQyxVQUFsRCxFQUE4REMsV0FBOUQsRUFBMUMsRUFBdUg7QUFBQTs7QUFBQTtBQUNuSCxnQkFBSXJCLFNBQVNoRCx1QkFBVCxJQUFvQytDLFFBQVEvQyx1QkFBaEQsRUFBeUU7QUFDckUsc0JBQU1zRSxZQUFZSixlQUFsQjtBQUNBLHNCQUFNSyxXQUFZQyxLQUFLQyxLQUFMLENBQVdOLGlCQUFpQixDQUE1QixDQUFsQjs7QUFFQSxzQkFBTSxPQUFLckIsWUFBTCxDQUFrQjFDLFNBQWxCLEVBQTZCbUUsUUFBN0IsRUFBdUNELFNBQXZDLEVBQWtERixVQUFsRCxFQUE4REMsV0FBOUQsQ0FBTjtBQUNIO0FBTmtIO0FBT3RIO0FBcEhVLEMiLCJmaWxlIjoiYnJvd3Nlci9wcm92aWRlci9idWlsdC1pbi9jaHJvbWUvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1MgZnJvbSAnb3MtZmFtaWx5JztcbmltcG9ydCB7IHBhcnNlIGFzIHBhcnNlVXJsIH0gZnJvbSAndXJsJztcbmltcG9ydCBnZXRSdW50aW1lSW5mbyBmcm9tICcuL3J1bnRpbWUtaW5mbyc7XG5pbXBvcnQgeyBzdGFydCBhcyBzdGFydExvY2FsQ2hyb21lLCBzdG9wIGFzIHN0b3BMb2NhbENocm9tZSB9IGZyb20gJy4vbG9jYWwtY2hyb21lJztcbmltcG9ydCAqIGFzIGNkcCBmcm9tICcuL2NkcCc7XG5pbXBvcnQgZ2V0TWF4aW1pemVkSGVhZGxlc3NXaW5kb3dTaXplIGZyb20gJy4uLy4uL3V0aWxzL2dldC1tYXhpbWl6ZWQtaGVhZGxlc3Mtd2luZG93LXNpemUnO1xuaW1wb3J0IHsgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIH0gZnJvbSAnLi4vLi4vdXRpbHMvY2xpZW50LWZ1bmN0aW9ucyc7XG5pbXBvcnQgeyBjcm9wU2NyZWVuc2hvdCB9IGZyb20gJy4uLy4uLy4uLy4uL3NjcmVlbnNob3RzL2Nyb3AnO1xuaW1wb3J0IHsgd3JpdGVQbmcgfSBmcm9tICcuLi8uLi8uLi8uLi9zY3JlZW5zaG90cy91dGlscyc7XG5cbmNvbnN0IE1JTl9BVkFJTEFCTEVfRElNRU5TSU9OID0gNTA7XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgICBvcGVuZWRCcm93c2Vyczoge30sXG5cbiAgICBpc011bHRpQnJvd3NlcjogZmFsc2UsXG5cbiAgICBhc3luYyBvcGVuQnJvd3NlciAoYnJvd3NlcklkLCBwYWdlVXJsLCBjb25maWdTdHJpbmcpIHtcbiAgICAgICAgY29uc3QgcnVudGltZUluZm8gPSBhd2FpdCBnZXRSdW50aW1lSW5mbyhwYXJzZVVybChwYWdlVXJsKS5ob3N0bmFtZSwgY29uZmlnU3RyaW5nKTtcbiAgICAgICAgY29uc3QgYnJvd3Nlck5hbWUgPSB0aGlzLnByb3ZpZGVyTmFtZS5yZXBsYWNlKCc6JywgJycpO1xuXG4gICAgICAgIHJ1bnRpbWVJbmZvLmJyb3dzZXJJZCAgID0gYnJvd3NlcklkO1xuICAgICAgICBydW50aW1lSW5mby5icm93c2VyTmFtZSA9IGJyb3dzZXJOYW1lO1xuXG4gICAgICAgIHJ1bnRpbWVJbmZvLnByb3ZpZGVyTWV0aG9kcyA9IHtcbiAgICAgICAgICAgIHJlc2l6ZUxvY2FsQnJvd3NlcldpbmRvdzogKC4uLmFyZ3MpID0+IHRoaXMucmVzaXplTG9jYWxCcm93c2VyV2luZG93KC4uLmFyZ3MpXG4gICAgICAgIH07XG5cbiAgICAgICAgYXdhaXQgc3RhcnRMb2NhbENocm9tZShwYWdlVXJsLCBydW50aW1lSW5mbyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yQ29ubmVjdGlvblJlYWR5KGJyb3dzZXJJZCk7XG5cbiAgICAgICAgcnVudGltZUluZm8udmlld3BvcnRTaXplID0gYXdhaXQgdGhpcy5ydW5Jbml0U2NyaXB0KGJyb3dzZXJJZCwgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUKTtcblxuICAgICAgICBhd2FpdCBjZHAuY3JlYXRlQ2xpZW50KHJ1bnRpbWVJbmZvKTtcblxuICAgICAgICB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF0gPSBydW50aW1lSW5mbztcblxuICAgICAgICBhd2FpdCB0aGlzLl9lbnN1cmVXaW5kb3dJc0V4cGFuZGVkKGJyb3dzZXJJZCwgcnVudGltZUluZm8udmlld3BvcnRTaXplKTtcbiAgICB9LFxuXG4gICAgYXN5bmMgY2xvc2VCcm93c2VyIChicm93c2VySWQpIHtcbiAgICAgICAgY29uc3QgcnVudGltZUluZm8gPSB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF07XG5cbiAgICAgICAgaWYgKGNkcC5pc0hlYWRsZXNzVGFiKHJ1bnRpbWVJbmZvKSlcbiAgICAgICAgICAgIGF3YWl0IGNkcC5jbG9zZVRhYihydW50aW1lSW5mbyk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2xvc2VMb2NhbEJyb3dzZXIoYnJvd3NlcklkKTtcblxuICAgICAgICBpZiAoT1MubWFjIHx8IHJ1bnRpbWVJbmZvLmNvbmZpZy5oZWFkbGVzcylcbiAgICAgICAgICAgIGF3YWl0IHN0b3BMb2NhbENocm9tZShydW50aW1lSW5mbyk7XG5cbiAgICAgICAgaWYgKHJ1bnRpbWVJbmZvLnRlbXBQcm9maWxlRGlyKVxuICAgICAgICAgICAgYXdhaXQgcnVudGltZUluZm8udGVtcFByb2ZpbGVEaXIuZGlzcG9zZSgpO1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF07XG4gICAgfSxcblxuICAgIGFzeW5jIGlzTG9jYWxCcm93c2VyICgpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSxcblxuICAgIGlzSGVhZGxlc3NCcm93c2VyIChicm93c2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3BlbmVkQnJvd3NlcnNbYnJvd3NlcklkXS5jb25maWcuaGVhZGxlc3M7XG4gICAgfSxcblxuICAgIGFzeW5jIHRha2VTY3JlZW5zaG90IChicm93c2VySWQsIHBhdGgpIHtcbiAgICAgICAgY29uc3QgcnVudGltZUluZm8gPSB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF07XG4gICAgICAgIGNvbnN0IHZpZXdwb3J0ICAgID0gYXdhaXQgY2RwLmdldFBhZ2VWaWV3cG9ydChydW50aW1lSW5mbyk7XG4gICAgICAgIGNvbnN0IGJpbmFyeUltYWdlID0gYXdhaXQgY2RwLmdldFNjcmVlbnNob3REYXRhKHJ1bnRpbWVJbmZvKTtcblxuICAgICAgICBjb25zdCB7IGNsaWVudFdpZHRoLCBjbGllbnRIZWlnaHQgfSA9IHZpZXdwb3J0O1xuXG4gICAgICAgIGNvbnN0IGNyb3BwZWRJbWFnZSA9IGF3YWl0IGNyb3BTY3JlZW5zaG90KHBhdGgsIGZhbHNlLCBudWxsLCB7XG4gICAgICAgICAgICByaWdodDogIGNsaWVudFdpZHRoLFxuICAgICAgICAgICAgbGVmdDogICAwLFxuICAgICAgICAgICAgdG9wOiAgICAwLFxuICAgICAgICAgICAgYm90dG9tOiBjbGllbnRIZWlnaHRcbiAgICAgICAgfSwgYmluYXJ5SW1hZ2UpO1xuXG4gICAgICAgIGlmIChjcm9wcGVkSW1hZ2UpXG4gICAgICAgICAgICBhd2FpdCB3cml0ZVBuZyhwYXRoLCBjcm9wcGVkSW1hZ2UpO1xuICAgIH0sXG5cbiAgICBhc3luYyByZXNpemVXaW5kb3cgKGJyb3dzZXJJZCwgd2lkdGgsIGhlaWdodCwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0KSB7XG4gICAgICAgIGNvbnN0IHJ1bnRpbWVJbmZvID0gdGhpcy5vcGVuZWRCcm93c2Vyc1ticm93c2VySWRdO1xuXG4gICAgICAgIGlmIChydW50aW1lSW5mby5jb25maWcubW9iaWxlKVxuICAgICAgICAgICAgYXdhaXQgY2RwLnVwZGF0ZU1vYmlsZVZpZXdwb3J0U2l6ZShydW50aW1lSW5mbyk7XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcnVudGltZUluZm8udmlld3BvcnRTaXplLndpZHRoICA9IGN1cnJlbnRXaWR0aDtcbiAgICAgICAgICAgIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZS5oZWlnaHQgPSBjdXJyZW50SGVpZ2h0O1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgY2RwLnJlc2l6ZVdpbmRvdyh7IHdpZHRoLCBoZWlnaHQgfSwgcnVudGltZUluZm8pO1xuICAgIH0sXG5cbiAgICBhc3luYyBtYXhpbWl6ZVdpbmRvdyAoYnJvd3NlcklkKSB7XG4gICAgICAgIGNvbnN0IG1heGltdW1TaXplID0gZ2V0TWF4aW1pemVkSGVhZGxlc3NXaW5kb3dTaXplKCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5yZXNpemVXaW5kb3coYnJvd3NlcklkLCBtYXhpbXVtU2l6ZS53aWR0aCwgbWF4aW11bVNpemUuaGVpZ2h0LCBtYXhpbXVtU2l6ZS53aWR0aCwgbWF4aW11bVNpemUuaGVpZ2h0KTtcbiAgICB9LFxuXG4gICAgYXN5bmMgZ2V0VmlkZW9GcmFtZURhdGEgKGJyb3dzZXJJZCkge1xuICAgICAgICByZXR1cm4gYXdhaXQgY2RwLmdldFNjcmVlbnNob3REYXRhKHRoaXMub3BlbmVkQnJvd3NlcnNbYnJvd3NlcklkXSk7XG4gICAgfSxcblxuICAgIGFzeW5jIGhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIgKGJyb3dzZXJJZCkge1xuICAgICAgICBjb25zdCB7IGNvbmZpZywgY2xpZW50IH0gPSB0aGlzLm9wZW5lZEJyb3dzZXJzW2Jyb3dzZXJJZF07XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGhhc0Nsb3NlQnJvd3NlcjogICAgICAgICAgICAgICAgdHJ1ZSxcbiAgICAgICAgICAgIGhhc1Jlc2l6ZVdpbmRvdzogICAgICAgICAgICAgICAgISFjbGllbnQgJiYgKGNvbmZpZy5lbXVsYXRpb24gfHwgY29uZmlnLmhlYWRsZXNzKSxcbiAgICAgICAgICAgIGhhc01heGltaXplV2luZG93OiAgICAgICAgICAgICAgISFjbGllbnQgJiYgY29uZmlnLmhlYWRsZXNzLFxuICAgICAgICAgICAgaGFzVGFrZVNjcmVlbnNob3Q6ICAgICAgICAgICAgICAhIWNsaWVudCxcbiAgICAgICAgICAgIGhhc0Nocm9tZWxlc3NTY3JlZW5zaG90czogICAgICAgISFjbGllbnQsXG4gICAgICAgICAgICBoYXNHZXRWaWRlb0ZyYW1lRGF0YTogICAgICAgICAgICEhY2xpZW50LFxuICAgICAgICAgICAgaGFzQ2FuUmVzaXplV2luZG93VG9EaW1lbnNpb25zOiBmYWxzZVxuICAgICAgICB9O1xuICAgIH0sXG5cbiAgICBhc3luYyBfZW5zdXJlV2luZG93SXNFeHBhbmRlZCAoYnJvd3NlcklkLCB7IGhlaWdodCwgd2lkdGgsIGF2YWlsYWJsZUhlaWdodCwgYXZhaWxhYmxlV2lkdGgsIG91dGVyV2lkdGgsIG91dGVySGVpZ2h0IH0pIHtcbiAgICAgICAgaWYgKGhlaWdodCA8IE1JTl9BVkFJTEFCTEVfRElNRU5TSU9OIHx8IHdpZHRoIDwgTUlOX0FWQUlMQUJMRV9ESU1FTlNJT04pIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld0hlaWdodCA9IGF2YWlsYWJsZUhlaWdodDtcbiAgICAgICAgICAgIGNvbnN0IG5ld1dpZHRoICA9IE1hdGguZmxvb3IoYXZhaWxhYmxlV2lkdGggLyAyKTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5yZXNpemVXaW5kb3coYnJvd3NlcklkLCBuZXdXaWR0aCwgbmV3SGVpZ2h0LCBvdXRlcldpZHRoLCBvdXRlckhlaWdodCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuIl19
