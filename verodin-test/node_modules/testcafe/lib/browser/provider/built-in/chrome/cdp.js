'use strict';

exports.__esModule = true;
exports.resizeWindow = exports.updateMobileViewportSize = exports.closeTab = exports.createClient = exports.getPageViewport = exports.getScreenshotData = undefined;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let getActiveTab = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (cdpPort, browserId) {
        const tabs = yield _chromeRemoteInterface2.default.listTabs({ port: cdpPort });
        const tab = tabs.filter(function (t) {
            return t.type === 'page' && t.url.indexOf(browserId) > -1;
        })[0];

        return tab;
    });

    return function getActiveTab(_x, _x2) {
        return _ref.apply(this, arguments);
    };
})();

let setEmulationBounds = (() => {
    var _ref2 = (0, _asyncToGenerator3.default)(function* ({ client, config, viewportSize, emulatedDevicePixelRatio }) {
        yield client.Emulation.setDeviceMetricsOverride({
            width: viewportSize.width,
            height: viewportSize.height,
            deviceScaleFactor: emulatedDevicePixelRatio,
            mobile: config.mobile,
            fitWindow: false
        });

        yield client.Emulation.setVisibleSize({ width: viewportSize.width, height: viewportSize.height });
    });

    return function setEmulationBounds(_x3) {
        return _ref2.apply(this, arguments);
    };
})();

let setEmulation = (() => {
    var _ref3 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        const client = runtimeInfo.client,
              config = runtimeInfo.config;


        if (config.userAgent !== void 0) yield client.Network.setUserAgentOverride({ userAgent: config.userAgent });

        if (config.touch !== void 0) {
            const touchConfig = {
                enabled: config.touch,
                configuration: config.mobile ? 'mobile' : 'desktop',
                maxTouchPoints: 1
            };

            if (client.Emulation.setEmitTouchEventsForMouse) yield client.Emulation.setEmitTouchEventsForMouse(touchConfig);

            if (client.Emulation.setTouchEmulationEnabled) yield client.Emulation.setTouchEmulationEnabled(touchConfig);
        }

        yield resizeWindow({ width: config.width, height: config.height }, runtimeInfo);
    });

    return function setEmulation(_x4) {
        return _ref3.apply(this, arguments);
    };
})();

let getScreenshotData = exports.getScreenshotData = (() => {
    var _ref4 = (0, _asyncToGenerator3.default)(function* ({ client }) {
        const screenshotData = yield client.Page.captureScreenshot();

        return Buffer.from(screenshotData.data, 'base64');
    });

    return function getScreenshotData(_x5) {
        return _ref4.apply(this, arguments);
    };
})();

let getPageViewport = exports.getPageViewport = (() => {
    var _ref5 = (0, _asyncToGenerator3.default)(function* ({ client }) {
        var _ref6 = yield client.Page.getLayoutMetrics();

        const visualViewport = _ref6.visualViewport;


        return visualViewport;
    });

    return function getPageViewport(_x6) {
        return _ref5.apply(this, arguments);
    };
})();

let createClient = exports.createClient = (() => {
    var _ref7 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        const browserId = runtimeInfo.browserId,
              config = runtimeInfo.config,
              cdpPort = runtimeInfo.cdpPort;


        let tab = null;
        let client = null;

        try {
            tab = yield getActiveTab(cdpPort, browserId);

            if (!tab) return;

            client = yield (0, _chromeRemoteInterface2.default)({ target: tab, port: cdpPort });
        } catch (e) {
            return;
        }

        runtimeInfo.tab = tab;
        runtimeInfo.client = client;

        yield client.Page.enable();
        yield client.Network.enable();
        yield client.Runtime.enable();

        const devicePixelRatioQueryResult = yield client.Runtime.evaluate({ expression: 'window.devicePixelRatio' });

        runtimeInfo.originalDevicePixelRatio = devicePixelRatioQueryResult.result.value;
        runtimeInfo.emulatedDevicePixelRatio = config.scaleFactor || runtimeInfo.originalDevicePixelRatio;

        if (config.emulation) yield setEmulation(runtimeInfo);
    });

    return function createClient(_x7) {
        return _ref7.apply(this, arguments);
    };
})();

let closeTab = exports.closeTab = (() => {
    var _ref8 = (0, _asyncToGenerator3.default)(function* ({ tab, cdpPort }) {
        yield _chromeRemoteInterface2.default.closeTab({ id: tab.id, port: cdpPort });
    });

    return function closeTab(_x8) {
        return _ref8.apply(this, arguments);
    };
})();

let updateMobileViewportSize = exports.updateMobileViewportSize = (() => {
    var _ref9 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        const windowDimensionsQueryResult = yield runtimeInfo.client.Runtime.evaluate({
            expression: `(${_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT})()`,
            returnByValue: true
        });

        const windowDimensions = windowDimensionsQueryResult.result.value;

        runtimeInfo.viewportSize.width = windowDimensions.outerWidth;
        runtimeInfo.viewportSize.height = windowDimensions.outerHeight;
    });

    return function updateMobileViewportSize(_x9) {
        return _ref9.apply(this, arguments);
    };
})();

let resizeWindow = exports.resizeWindow = (() => {
    var _ref10 = (0, _asyncToGenerator3.default)(function* (newDimensions, runtimeInfo) {
        const browserId = runtimeInfo.browserId,
              config = runtimeInfo.config,
              viewportSize = runtimeInfo.viewportSize,
              providerMethods = runtimeInfo.providerMethods;


        const currentWidth = viewportSize.width;
        const currentHeight = viewportSize.height;
        const newWidth = newDimensions.width || currentWidth;
        const newHeight = newDimensions.height || currentHeight;

        if (!config.headless) yield providerMethods.resizeLocalBrowserWindow(browserId, newWidth, newHeight, currentWidth, currentHeight);

        viewportSize.width = newWidth;
        viewportSize.height = newHeight;

        if (config.emulation) yield setEmulationBounds(runtimeInfo);
    });

    return function resizeWindow(_x10, _x11) {
        return _ref10.apply(this, arguments);
    };
})();

exports.isHeadlessTab = isHeadlessTab;

var _chromeRemoteInterface = require('chrome-remote-interface');

var _chromeRemoteInterface2 = _interopRequireDefault(_chromeRemoteInterface);

var _clientFunctions = require('../../utils/client-functions');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isHeadlessTab({ tab, config }) {
    return tab && config.headless;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9jZHAuanMiXSwibmFtZXMiOlsiY2RwUG9ydCIsImJyb3dzZXJJZCIsInRhYnMiLCJyZW1vdGVDaHJvbWUiLCJsaXN0VGFicyIsInBvcnQiLCJ0YWIiLCJmaWx0ZXIiLCJ0IiwidHlwZSIsInVybCIsImluZGV4T2YiLCJnZXRBY3RpdmVUYWIiLCJjbGllbnQiLCJjb25maWciLCJ2aWV3cG9ydFNpemUiLCJlbXVsYXRlZERldmljZVBpeGVsUmF0aW8iLCJFbXVsYXRpb24iLCJzZXREZXZpY2VNZXRyaWNzT3ZlcnJpZGUiLCJ3aWR0aCIsImhlaWdodCIsImRldmljZVNjYWxlRmFjdG9yIiwibW9iaWxlIiwiZml0V2luZG93Iiwic2V0VmlzaWJsZVNpemUiLCJzZXRFbXVsYXRpb25Cb3VuZHMiLCJydW50aW1lSW5mbyIsInVzZXJBZ2VudCIsIk5ldHdvcmsiLCJzZXRVc2VyQWdlbnRPdmVycmlkZSIsInRvdWNoIiwidG91Y2hDb25maWciLCJlbmFibGVkIiwiY29uZmlndXJhdGlvbiIsIm1heFRvdWNoUG9pbnRzIiwic2V0RW1pdFRvdWNoRXZlbnRzRm9yTW91c2UiLCJzZXRUb3VjaEVtdWxhdGlvbkVuYWJsZWQiLCJyZXNpemVXaW5kb3ciLCJzZXRFbXVsYXRpb24iLCJzY3JlZW5zaG90RGF0YSIsIlBhZ2UiLCJjYXB0dXJlU2NyZWVuc2hvdCIsIkJ1ZmZlciIsImZyb20iLCJkYXRhIiwiZ2V0U2NyZWVuc2hvdERhdGEiLCJnZXRMYXlvdXRNZXRyaWNzIiwidmlzdWFsVmlld3BvcnQiLCJnZXRQYWdlVmlld3BvcnQiLCJ0YXJnZXQiLCJlIiwiZW5hYmxlIiwiUnVudGltZSIsImRldmljZVBpeGVsUmF0aW9RdWVyeVJlc3VsdCIsImV2YWx1YXRlIiwiZXhwcmVzc2lvbiIsIm9yaWdpbmFsRGV2aWNlUGl4ZWxSYXRpbyIsInJlc3VsdCIsInZhbHVlIiwic2NhbGVGYWN0b3IiLCJlbXVsYXRpb24iLCJjcmVhdGVDbGllbnQiLCJjbG9zZVRhYiIsImlkIiwid2luZG93RGltZW5zaW9uc1F1ZXJ5UmVzdWx0IiwiR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIiwicmV0dXJuQnlWYWx1ZSIsIndpbmRvd0RpbWVuc2lvbnMiLCJvdXRlcldpZHRoIiwib3V0ZXJIZWlnaHQiLCJ1cGRhdGVNb2JpbGVWaWV3cG9ydFNpemUiLCJuZXdEaW1lbnNpb25zIiwicHJvdmlkZXJNZXRob2RzIiwiY3VycmVudFdpZHRoIiwiY3VycmVudEhlaWdodCIsIm5ld1dpZHRoIiwibmV3SGVpZ2h0IiwiaGVhZGxlc3MiLCJyZXNpemVMb2NhbEJyb3dzZXJXaW5kb3ciLCJpc0hlYWRsZXNzVGFiIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OytDQUlBLFdBQTZCQSxPQUE3QixFQUFzQ0MsU0FBdEMsRUFBaUQ7QUFDN0MsY0FBTUMsT0FBTyxNQUFNQyxnQ0FBYUMsUUFBYixDQUFzQixFQUFFQyxNQUFNTCxPQUFSLEVBQXRCLENBQW5CO0FBQ0EsY0FBTU0sTUFBT0osS0FBS0ssTUFBTCxDQUFZO0FBQUEsbUJBQUtDLEVBQUVDLElBQUYsS0FBVyxNQUFYLElBQXFCRCxFQUFFRSxHQUFGLENBQU1DLE9BQU4sQ0FBY1YsU0FBZCxJQUEyQixDQUFDLENBQXREO0FBQUEsU0FBWixFQUFxRSxDQUFyRSxDQUFiOztBQUVBLGVBQU9LLEdBQVA7QUFDSCxLOztvQkFMY00sWTs7Ozs7O2dEQU9mLFdBQW1DLEVBQUVDLE1BQUYsRUFBVUMsTUFBVixFQUFrQkMsWUFBbEIsRUFBZ0NDLHdCQUFoQyxFQUFuQyxFQUErRjtBQUMzRixjQUFNSCxPQUFPSSxTQUFQLENBQWlCQyx3QkFBakIsQ0FBMEM7QUFDNUNDLG1CQUFtQkosYUFBYUksS0FEWTtBQUU1Q0Msb0JBQW1CTCxhQUFhSyxNQUZZO0FBRzVDQywrQkFBbUJMLHdCQUh5QjtBQUk1Q00sb0JBQW1CUixPQUFPUSxNQUprQjtBQUs1Q0MsdUJBQW1CO0FBTHlC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WCxZQURpQztBQUFBLGNBQ25CeUQsZUFEbUIsR0FDQzlDLFdBREQsQ0FDbkI4QyxlQURtQjs7O0FBRzVELGNBQU1DLGVBQWdCMUQsYUFBYUksS0FBbkM7QUFDQSxjQUFNdUQsZ0JBQWdCM0QsYUFBYUssTUFBbkM7QUFDQSxjQUFNdUQsV0FBZ0JKLGNBQWNwRCxLQUFkLElBQXVCc0QsWUFBN0M7QUFDQSxjQUFNRyxZQUFnQkwsY0FBY25ELE1BQWQsSUFBd0JzRCxhQUE5Qzs7QUFFQSxZQUFJLENBQUM1RCxPQUFPK0QsUUFBWixFQUNJLE1BQU1MLGdCQUFnQk0sd0JBQWhCLENBQXlDN0UsU0FBekMsRUFBb0QwRSxRQUFwRCxFQUE4REMsU0FBOUQsRUFBeUVILFlBQXpFLEVBQXVGQyxhQUF2RixDQUFOOztBQUVKM0QscUJBQWFJLEtBQWIsR0FBc0J3RCxRQUF0QjtBQUNBNUQscUJBQWFLLE1BQWIsR0FBc0J3RCxTQUF0Qjs7QUFFQSxZQUFJOUQsT0FBTzhDLFNBQVgsRUFDSSxNQUFNbkMsbUJBQW1CQyxXQUFuQixDQUFOO0FBQ1AsSzs7b0JBaEJxQlcsWTs7Ozs7UUFwQk4wQyxhLEdBQUFBLGE7O0FBNUZoQjs7OztBQUNBOzs7O0FBMkZPLFNBQVNBLGFBQVQsQ0FBd0IsRUFBRXpFLEdBQUYsRUFBT1EsTUFBUCxFQUF4QixFQUF5QztBQUM1QyxXQUFPUixPQUFPUSxPQUFPK0QsUUFBckI7QUFDSCIsImZpbGUiOiJicm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9jZHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcmVtb3RlQ2hyb21lIGZyb20gJ2Nocm9tZS1yZW1vdGUtaW50ZXJmYWNlJztcbmltcG9ydCB7IEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCB9IGZyb20gJy4uLy4uL3V0aWxzL2NsaWVudC1mdW5jdGlvbnMnO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFjdGl2ZVRhYiAoY2RwUG9ydCwgYnJvd3NlcklkKSB7XG4gICAgY29uc3QgdGFicyA9IGF3YWl0IHJlbW90ZUNocm9tZS5saXN0VGFicyh7IHBvcnQ6IGNkcFBvcnQgfSk7XG4gICAgY29uc3QgdGFiICA9IHRhYnMuZmlsdGVyKHQgPT4gdC50eXBlID09PSAncGFnZScgJiYgdC51cmwuaW5kZXhPZihicm93c2VySWQpID4gLTEpWzBdO1xuXG4gICAgcmV0dXJuIHRhYjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0RW11bGF0aW9uQm91bmRzICh7IGNsaWVudCwgY29uZmlnLCB2aWV3cG9ydFNpemUsIGVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyB9KSB7XG4gICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXREZXZpY2VNZXRyaWNzT3ZlcnJpZGUoe1xuICAgICAgICB3aWR0aDogICAgICAgICAgICAgdmlld3BvcnRTaXplLndpZHRoLFxuICAgICAgICBoZWlnaHQ6ICAgICAgICAgICAgdmlld3BvcnRTaXplLmhlaWdodCxcbiAgICAgICAgZGV2aWNlU2NhbGVGYWN0b3I6IGVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyxcbiAgICAgICAgbW9iaWxlOiAgICAgICAgICAgIGNvbmZpZy5tb2JpbGUsXG4gICAgICAgIGZpdFdpbmRvdzogICAgICAgICBmYWxzZVxuICAgIH0pO1xuXG4gICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRWaXNpYmxlU2l6ZSh7IHdpZHRoOiB2aWV3cG9ydFNpemUud2lkdGgsIGhlaWdodDogdmlld3BvcnRTaXplLmhlaWdodCB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0RW11bGF0aW9uIChydW50aW1lSW5mbykge1xuICAgIGNvbnN0IHsgY2xpZW50LCBjb25maWcgfSA9IHJ1bnRpbWVJbmZvO1xuXG4gICAgaWYgKGNvbmZpZy51c2VyQWdlbnQgIT09IHZvaWQgMClcbiAgICAgICAgYXdhaXQgY2xpZW50Lk5ldHdvcmsuc2V0VXNlckFnZW50T3ZlcnJpZGUoeyB1c2VyQWdlbnQ6IGNvbmZpZy51c2VyQWdlbnQgfSk7XG5cbiAgICBpZiAoY29uZmlnLnRvdWNoICE9PSB2b2lkIDApIHtcbiAgICAgICAgY29uc3QgdG91Y2hDb25maWcgPSB7XG4gICAgICAgICAgICBlbmFibGVkOiAgICAgICAgY29uZmlnLnRvdWNoLFxuICAgICAgICAgICAgY29uZmlndXJhdGlvbjogIGNvbmZpZy5tb2JpbGUgPyAnbW9iaWxlJyA6ICdkZXNrdG9wJyxcbiAgICAgICAgICAgIG1heFRvdWNoUG9pbnRzOiAxXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGNsaWVudC5FbXVsYXRpb24uc2V0RW1pdFRvdWNoRXZlbnRzRm9yTW91c2UpXG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuRW11bGF0aW9uLnNldEVtaXRUb3VjaEV2ZW50c0Zvck1vdXNlKHRvdWNoQ29uZmlnKTtcblxuICAgICAgICBpZiAoY2xpZW50LkVtdWxhdGlvbi5zZXRUb3VjaEVtdWxhdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuRW11bGF0aW9uLnNldFRvdWNoRW11bGF0aW9uRW5hYmxlZCh0b3VjaENvbmZpZyk7XG4gICAgfVxuXG4gICAgYXdhaXQgcmVzaXplV2luZG93KHsgd2lkdGg6IGNvbmZpZy53aWR0aCwgaGVpZ2h0OiBjb25maWcuaGVpZ2h0IH0sIHJ1bnRpbWVJbmZvKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbnNob3REYXRhICh7IGNsaWVudCB9KSB7XG4gICAgY29uc3Qgc2NyZWVuc2hvdERhdGEgPSBhd2FpdCBjbGllbnQuUGFnZS5jYXB0dXJlU2NyZWVuc2hvdCgpO1xuXG4gICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHNjcmVlbnNob3REYXRhLmRhdGEsICdiYXNlNjQnKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFBhZ2VWaWV3cG9ydCAoeyBjbGllbnQgfSkge1xuICAgIGNvbnN0IHsgdmlzdWFsVmlld3BvcnQgfSA9IGF3YWl0IGNsaWVudC5QYWdlLmdldExheW91dE1ldHJpY3MoKTtcblxuICAgIHJldHVybiB2aXN1YWxWaWV3cG9ydDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUNsaWVudCAocnVudGltZUluZm8pIHtcbiAgICBjb25zdCB7IGJyb3dzZXJJZCwgY29uZmlnLCBjZHBQb3J0IH0gPSBydW50aW1lSW5mbztcblxuICAgIGxldCB0YWIgICAgPSBudWxsO1xuICAgIGxldCBjbGllbnQgPSBudWxsO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgdGFiID0gYXdhaXQgZ2V0QWN0aXZlVGFiKGNkcFBvcnQsIGJyb3dzZXJJZCk7XG5cbiAgICAgICAgaWYgKCF0YWIpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY2xpZW50ID0gYXdhaXQgcmVtb3RlQ2hyb21lKHsgdGFyZ2V0OiB0YWIsIHBvcnQ6IGNkcFBvcnQgfSk7XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBydW50aW1lSW5mby50YWIgICAgPSB0YWI7XG4gICAgcnVudGltZUluZm8uY2xpZW50ID0gY2xpZW50O1xuXG4gICAgYXdhaXQgY2xpZW50LlBhZ2UuZW5hYmxlKCk7XG4gICAgYXdhaXQgY2xpZW50Lk5ldHdvcmsuZW5hYmxlKCk7XG4gICAgYXdhaXQgY2xpZW50LlJ1bnRpbWUuZW5hYmxlKCk7XG5cbiAgICBjb25zdCBkZXZpY2VQaXhlbFJhdGlvUXVlcnlSZXN1bHQgPSBhd2FpdCBjbGllbnQuUnVudGltZS5ldmFsdWF0ZSh7IGV4cHJlc3Npb246ICd3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbycgfSk7XG5cbiAgICBydW50aW1lSW5mby5vcmlnaW5hbERldmljZVBpeGVsUmF0aW8gPSBkZXZpY2VQaXhlbFJhdGlvUXVlcnlSZXN1bHQucmVzdWx0LnZhbHVlO1xuICAgIHJ1bnRpbWVJbmZvLmVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyA9IGNvbmZpZy5zY2FsZUZhY3RvciB8fCBydW50aW1lSW5mby5vcmlnaW5hbERldmljZVBpeGVsUmF0aW87XG5cbiAgICBpZiAoY29uZmlnLmVtdWxhdGlvbilcbiAgICAgICAgYXdhaXQgc2V0RW11bGF0aW9uKHJ1bnRpbWVJbmZvKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzSGVhZGxlc3NUYWIgKHsgdGFiLCBjb25maWcgfSkge1xuICAgIHJldHVybiB0YWIgJiYgY29uZmlnLmhlYWRsZXNzO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xvc2VUYWIgKHsgdGFiLCBjZHBQb3J0IH0pIHtcbiAgICBhd2FpdCByZW1vdGVDaHJvbWUuY2xvc2VUYWIoeyBpZDogdGFiLmlkLCBwb3J0OiBjZHBQb3J0IH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlTW9iaWxlVmlld3BvcnRTaXplIChydW50aW1lSW5mbykge1xuICAgIGNvbnN0IHdpbmRvd0RpbWVuc2lvbnNRdWVyeVJlc3VsdCA9IGF3YWl0IHJ1bnRpbWVJbmZvLmNsaWVudC5SdW50aW1lLmV2YWx1YXRlKHtcbiAgICAgICAgZXhwcmVzc2lvbjogICAgYCgke0dFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVH0pKClgLFxuICAgICAgICByZXR1cm5CeVZhbHVlOiB0cnVlXG4gICAgfSk7XG5cbiAgICBjb25zdCB3aW5kb3dEaW1lbnNpb25zID0gd2luZG93RGltZW5zaW9uc1F1ZXJ5UmVzdWx0LnJlc3VsdC52YWx1ZTtcblxuICAgIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZS53aWR0aCAgPSB3aW5kb3dEaW1lbnNpb25zLm91dGVyV2lkdGg7XG4gICAgcnVudGltZUluZm8udmlld3BvcnRTaXplLmhlaWdodCA9IHdpbmRvd0RpbWVuc2lvbnMub3V0ZXJIZWlnaHQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXNpemVXaW5kb3cgKG5ld0RpbWVuc2lvbnMsIHJ1bnRpbWVJbmZvKSB7XG4gICAgY29uc3QgeyBicm93c2VySWQsIGNvbmZpZywgdmlld3BvcnRTaXplLCBwcm92aWRlck1ldGhvZHMgfSA9IHJ1bnRpbWVJbmZvO1xuXG4gICAgY29uc3QgY3VycmVudFdpZHRoICA9IHZpZXdwb3J0U2l6ZS53aWR0aDtcbiAgICBjb25zdCBjdXJyZW50SGVpZ2h0ID0gdmlld3BvcnRTaXplLmhlaWdodDtcbiAgICBjb25zdCBuZXdXaWR0aCAgICAgID0gbmV3RGltZW5zaW9ucy53aWR0aCB8fCBjdXJyZW50V2lkdGg7XG4gICAgY29uc3QgbmV3SGVpZ2h0ICAgICA9IG5ld0RpbWVuc2lvbnMuaGVpZ2h0IHx8IGN1cnJlbnRIZWlnaHQ7XG5cbiAgICBpZiAoIWNvbmZpZy5oZWFkbGVzcylcbiAgICAgICAgYXdhaXQgcHJvdmlkZXJNZXRob2RzLnJlc2l6ZUxvY2FsQnJvd3NlcldpbmRvdyhicm93c2VySWQsIG5ld1dpZHRoLCBuZXdIZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCk7XG5cbiAgICB2aWV3cG9ydFNpemUud2lkdGggID0gbmV3V2lkdGg7XG4gICAgdmlld3BvcnRTaXplLmhlaWdodCA9IG5ld0hlaWdodDtcblxuICAgIGlmIChjb25maWcuZW11bGF0aW9uKVxuICAgICAgICBhd2FpdCBzZXRFbXVsYXRpb25Cb3VuZHMocnVudGltZUluZm8pO1xufVxuIl19
